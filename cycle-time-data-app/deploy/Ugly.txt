<!DOCTYPE html>
<html>
<head>
    <title>cycle-time-data-app-0.4.0</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Thu Sep 13 2018 17:47:25 GMT+0000 (UTC) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Thu Sep 13 2018 17:47:25 GMT+0000 (UTC)";
        var CHECKSUM = 132741875905;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("TsConstants",{statics:{LABELS:{BLOCKED:"Blocked",READY:"Ready",TIME_TO_MARKET:"Time To Market",IN_BLOCKED:"In Blocked",IN_READY:"In Ready"}}}),Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:Ext.String.format("Build date/time: {0} ({1})",APP_BUILD_DATE,BUILDER)})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("CArABU.technicalservices.CycleTimeCalculator",{singleton:!0,precision:0,granularity:"day",creationDateText:"(Creation)",noStateText:"(No State)",flowStates:{},getTimeInStateData:function(a,b,c,d){a=_.sortBy(a,d),c===CArABU.technicalservices.CycleTimeCalculator.noStateText&&(c="");var e=a[0][b]===c;"FlowState"==b&&(e=this.flowStates[a[0][b]]===c);var f=e?Rally.util.DateTime.fromIsoString(a[0][d]):null,g=[],h=0;return f&&(g[h]=[f]),Ext.Array.each(a,function(a){var f=Rally.util.DateTime.fromIsoString(a[d]),i=a[b];"FlowState"==b&&(i=this.flowStates[i]||""),e&&i!==c?(g[h].push(f),h++,e=!1):e||i!==c||(g[h]=[f],e=!0)},this),g},getCycleTimeData:function(a,b,c,d,e){var f=-1;e=_.filter(e,function(a){return a!==CArABU.technicalservices.CycleTimeCalculator.noStateText||""!==a}),Ext.isEmpty(c)||(f=_.indexOf(e,c));var g=_.indexOf(e,d),h=null,i=null,j=-1,k=-1,l=null;return-1===f&&(h=Rally.util.DateTime.fromIsoString(a[0]._ValidFrom)),Ext.each(a,function(a){var c=Rally.util.DateTime.fromIsoString(a._ValidFrom),d=a[b];"FlowState"==b&&(d=this.flowStates[d]||""),d?(j=k,k=_.indexOf(e,d)):j>0&&(k=-1),k>=f&&f>j&&f>-1&&null===h&&(h=c),k>=g&&g>j&&(i=c,null!=h&&(l=Rally.util.DateTime.getDifference(i,h,"second")))},this),g>k&&(l=null),l&&(l/=CArABU.technicalservices.CycleTimeCalculator.getGranularityMultiplier(CArABU.technicalservices.CycleTimeCalculator.granularity),l=l.toFixed(CArABU.technicalservices.CycleTimeCalculator.precision)),{cycleTime:l,endDate:i,startDate:h}},getGranularityMultiplier:function(a){return a=a.toLowerCase(),"minute"===a?60:"hour"===a?3600:"week"===a?604800:86400},calculateTimeInState:function(a){var b=0;return Ext.Array.each(a,function(a){var c=a.length>0&&a[0]||null,d=a.length>1&&a[1]||new Date;c&&d&&(b+=Rally.util.DateTime.getDifference(d,c,"second"))}),b/=CArABU.technicalservices.CycleTimeCalculator.getGranularityMultiplier(CArABU.technicalservices.CycleTimeCalculator.granularity),b.toFixed(CArABU.technicalservices.CycleTimeCalculator.precision)},getRenderedTimeInStateValue:function(a,b,c,d){var e=a&&a[b];return e&&c&&(e=e[c]),e&&0!==e.length?CArABU.technicalservices.CycleTimeCalculator.calculateTimeInState(e):d},getFirstStartDate:function(a,b,c){var d=a&&a[b];return d&&c&&(d=d[c]),d&&d.length>0?d[0][0]:null},getLastEndDate:function(a,b,c){var d=a&&a[b];return d&&c&&(d=d[c]),d&&d.length>0?d[d.length-1]&&d[d.length-1][0]||null:null},getExportTimestampCSV:function(a,b){for(var c=["FormattedID","State","StateValue","StartDate","EndDate"],d=[c.join(",")],e=function(a,c,d,e){var f=a.length>0&&a[0]&&Rally.util.DateTime.format(a[0],b)||"",g=a.length>1&&a[1]&&Rally.util.DateTime.format(a[1],b)||"",h=[c,d,e,f,g];return h.join(",")},f=0;f<a.length;f++){var g=a[f].get("timeInStateData"),h=a[f].get("FormattedID");g&&Ext.Object.each(g,function(a,b){"snaps"!=a&&(Ext.isArray(b)?Ext.Array.each(b,function(b){d.push(e(b,h,a,"true"))}):Ext.Object.each(b,function(b,c){Ext.Array.each(c,function(c){d.push(e(c,h,a,b))})}))})}return d.join("\r\n")}}),Ext.define("CA.technicalservices.CycleTimePickerButton",{extend:"Rally.ui.Button",alias:"widget.cycletimepickerbutton",cls:"secondary rly-small",iconCls:"icon-history",stateful:!0,stateId:"cycleTimePanel",stateEvents:["click","expand","collapse","parametersupdated"],text:"",config:{context:void 0,modelNames:void 0,toolTipConfig:{anchor:"top",mouseOffset:[-9,-2]}},initComponent:function(){this.callParent(arguments),(!this.stateful||this.stateful&&!this._hasState())&&this.applyState({}),this.on("click",this._togglePanel,this,{buffer:200}),this.on("parametersupdated",this._onPanelChange,this,{buffer:500})},_hasState:function(){return this.stateful&&this.stateId?!!Ext.state.Manager.get(this.stateId):!1},_onPanelChange:function(a){Ext.suspendLayouts(),this.hasValidCycleTimeParameters()?(this.setText("Active Cycle Time Data"),this._indicateActiveFilterPresent()):(this.setText(""),this._indicateNoActiveFilterPresent()),Ext.resumeLayouts(!1),this.fireEvent("cycletimeparametersupdated",this)},afterRender:function(){this.callParent(arguments),this.toolTip.on("beforeshow",this._onBeforeShowToolTip,this)},hasValidCycleTimeParameters:function(){return this.cycleTimePanel&&this.cycleTimePanel.hasValidCycleTimeParameters()},getCycleTimeParameters:function(){return this.cycleTimePanel&&this.cycleTimePanel.getCycleTimeParameters()},getState:function(){if(this.cycleTimePanel){var a=this.cycleTimePanel.getCycleTimeParameters();return a.collapsed=this.cycleTimePanel.getCollapsed(),a}return Ext.state.Manager.get(this.stateId)},applyState:function(a){this._build(a)},onDestroy:function(){_.invoke(_.compact([this.relayedEvents,this.cycleTimePanel]),"destroy"),this.callParent(arguments)},clearAllFilters:function(){this.cycleTimePanel&&this.cycleTimePanel.clear()},_build:function(a){return this._loadModels().then({success:_.partial(this._onModelLoadSuccess,a),scope:this})},_onModelLoadSuccess:function(a){this._createCycleTimePanel(),a&&this._applyParameters()},_loadModels:function(){return this.models?Deft.Promise.when(this.models):Rally.data.ModelFactory.getModels({context:this.context||Rally.environment.getContext(),types:this.modelNames}).then({success:function(a){this.models=a},scope:this})},_applyParameters:function(a){},_indicateActiveFilterPresent:function(){this.hasCls("primary")||(this.addCls("primary"),this.removeCls("secondary"))},_indicateNoActiveFilterPresent:function(){this.hasCls("secondary")||(this.addCls("secondary"),this.removeCls("primary"))},_createCycleTimePanel:function(){this.cycleTimePanel||(this.cycleTimePanel=Ext.widget({xtype:"cycletimepickerpanel",modelNames:this.modelNames,models:this.models,context:this.context,flex:1}),this.relayedEvents=this.relayEvents(this.cycleTimePanel,["expand","collapse","panelresize","parametersupdated"]),this.fireEvent("cycletimepickerready",this.cycleTimePanel))},_togglePanel:function(){this.cycleTimePanel&&this.cycleTimePanel.toggleCollapse()},collapse:function(){this.cycleTimePanel&&this.cycleTimePanel.collapse()},_onBeforeShowToolTip:function(){var a=this.cycleTimePanel&&this.cycleTimePanel.collapsed?"Show":"Hide";this.toolTip.update(Ext.String.format("{0} Cycle Time parameters",a))}}),Ext.define("CArABU.technicalservices.CycleTimeDataStore",{logger:new Rally.technicalservices.Logger,MAX_CHUNK_SIZE:25,USE_POST:!1,constructor:function(a){this.modelNames=a.modelNames,this.stateField=a.stateField,this.includeReady=a.includeReady||!1,this.includeBlocked=a.includeBlocked||!1,this.stateValues=a.stateValues||[],this.fromState=a.fromState,this.toState=a.toState,this.startDate=a.startDate||null,this.endDate=a.endDate||null},load:function(a){var b=Ext.create("Deft.Deferred"),c=_.map(a,function(a){return a.get("ObjectID")});this.logger.log("objectIDs",c);for(var d=[],e=0;e<c.length;e+=this.MAX_CHUNK_SIZE){var f=Ext.Array.slice(c,e,e+this.MAX_CHUNK_SIZE);d.push(this._fetchChunk(f))}return Deft.Promise.all(d).then({success:function(c){this.logger.log("load Success",c);var d=this._getSnapshotsByOid(c),e=this._updateRecords(d,a);b.resolve(e)},failure:function(a){this.logger.log("load Failure",a)},scope:this}),b},_getSnapshotsByOid:function(a){a=_.flatten(a);var b={};return Ext.Array.each(a,function(a){var c=a.get("ObjectID");b[c]||(b[c]=[]),b[c].push(a.getData())}),b},_updateRecords:function(a,b){var c=[];return Ext.Array.each(b,function(b){var d=b.get("ObjectID"),e=a[d],f=this._mungeCycleTimeData(e),g=this._mungeTimeInStateData(e);f&&this._isCycleInDateRange(f,this.startDate,this.endDate)&&(b.set("cycleTimeData",f),b.set("timeInStateData",g),c.push(b))},this),c},_isCycleInDateRange:function(a,b,c){return b&&a.endDate<b?!1:c&&a.endDate>c?!1:!0},_mungeCycleTimeData:function(a){if(!a||0===a.length)return null;var b=CArABU.technicalservices.CycleTimeCalculator.getCycleTimeData(a,this.stateField,this.fromState,this.toState,this.stateValues);return b.snaps=a,b},_mungeTimeInStateData:function(a){if(!a||0===a.length)return null;var b={snaps:a};b.Blocked=CArABU.technicalservices.CycleTimeCalculator.getTimeInStateData(a,"Blocked",!0,"_ValidFrom","minute"),b.Ready=CArABU.technicalservices.CycleTimeCalculator.getTimeInStateData(a,"Ready",!0,"_ValidFrom","minute");var c=this.stateField;return b[c]={},Ext.Array.each(this.stateValues,function(d){b[c][d]=CArABU.technicalservices.CycleTimeCalculator.getTimeInStateData(a,c,d,"_ValidFrom")}),b},_fetchChunk:function(a){var b=Ext.create("Deft.Deferred");return Ext.create("Rally.data.lookback.SnapshotStore",{fetch:this._getFetchList(),filters:[{property:"ObjectID",operator:"in",value:a}],useHttpPost:this.USE_POST,sorters:[{property:"ObjectID",direction:"ASC"},{property:"_ValidFrom",direction:"ASC"}],hydrate:this._getHydrateFields(),compress:!0,removeUnauthorizedSnapshots:!0}).load({callback:function(c,d,e){if(e)b.resolve(c);else{var f="Failure loading snapshots for objectIDs: "+a.join(", ")+":  "+d.error.errors.join(",");console.log(f),b.resolve([])}}}),b},_getFetchList:function(){var a=["FormattedID","_ValidFrom","_ValidTo","ObjectID",this.stateField,"_PreviousValues."+this.stateField];return this.includeReady&&(a=a.concat(["Ready","_PreviousValues.Ready"])),this.includeBlocked&&(a=a.concat(["Blocked","_PreviousValues.Blocked"])),a},_getHydrateFields:function(){var a=["ScheduleState","State"];return Ext.Array.contains(a,this.stateField)?[this.stateField,"_PreviousValues."+this.stateField]:[]}}),Ext.define("CA.technicalservices.CycleTimePickerPanel",{extend:"Ext.panel.Panel",alias:"widget.cycletimepickerpanel",cls:"inline-filter-panel",flex:1,header:!1,minHeight:46,padding:"8px 0 0 0",bodyPadding:"7px 5px 5px 5px",collapseDirection:"top",collapsible:!0,animCollapse:!1,stateful:!0,stateId:"cycleTimePanel",constructor:function(a){this.mergeConfig(a),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),(!this.stateful||this.stateful&&!this._hasState())&&this.applyState({})},_hasState:function(){return this.stateful&&this.stateId?!!Ext.state.Manager.get(this.stateId):!1},_loadModels:function(a){return this.models?void this._addItems(a):void(this.context&&this.modelNames&&this.modelNames.length>0&&Rally.data.ModelFactory.getModels({types:this.modelNames,context:this.context,success:function(b){this.models=b,this._addItems(a)},scope:this}))},_addItems:function(a){a||(a={}),this.removeAll(),this.add({xtype:"rallybutton",cls:"inline-filter-panel-close icon-cross",height:18,userAction:"Close (X) filter panel clicked",listeners:{click:function(){this.collapse()},scope:this}}),this.add({xtype:"container",flex:1,layout:"hbox",items:[{xtype:"rallyfieldcombobox",model:this.modelNames[0],itemId:"cb-StateField",fieldLabel:"Cycle Time Field",labelAlign:"right",labelWidth:150,width:300,context:this.context,value:a.cycleStateField,_isNotHidden:this._isCycleTimeField},{xtype:"rallybutton",enableToggle:!0,itemId:"btBlocked",margin:"6 6 6 185",cls:a.showBlocked?"primary rly-small":"secondary rly-small",iconCls:"icon-blocked",toolTipText:"Calculate time in Blocked state",pressed:a.showBlocked||!1,listeners:{toggle:this._toggleButton,scope:this}},{xtype:"rallybutton",enableToggle:!0,itemId:"btReady",margin:6,iconCls:"icon-ok",cls:a.showReady?"primary rly-small":"secondary rly-small",pressed:a.showReady||!1,toolTipText:"Calculate time in Ready state",listeners:{toggle:this._toggleButton,scope:this}}]});var b=[],c=[];a.cycleStates&&a.cycleStates.length>0&&(Ext.Array.each(a.cycleStates,function(d){"ScheduleState"!==a.cycleStateField&&b.push(CArABU.technicalservices.CycleTimeCalculator.noStateText),b.push(d),(!a.cycleEndState||a.cycleEndState===d||c.length>0)&&c.push(d)}),b=_.map(a.cycleStates,function(a){return{value:a}}),c=_.map(a.cycleStates,function(a){return{value:a}})),this.add({xtype:"container",flex:1,layout:"hbox",items:[{xtype:"rallycombobox",itemId:"cb-fromState",allowBlank:!0,allowNoEntry:!0,noEntryText:"-- No State --",fieldLabel:"Cycle Time State From",labelAlign:"right",labelWidth:150,width:300,store:Ext.create("Rally.data.custom.Store",{data:b}),value:a.cycleStartState||null,valueField:"value",displayField:"value"},{xtype:"rallycombobox",itemId:"cb-toState",fieldLabel:"to",labelWidth:15,labelAlign:"right",width:165,allowBlank:!1,disabled:0===c.length,store:Ext.create("Rally.data.custom.Store",{data:c}),value:a.cycleEndState||null,valueField:"value",displayField:"value",listeners:{scope:this,select:this.updateCycleTimeParameters}}]},{xtype:"container",flex:1,layout:"hbox",items:[{xtype:"rallydatefield",fieldLabel:"Cycle End Date From",labelSeparator:"",itemId:"dtFrom",labelAlign:"right",labelWidth:150,width:300,value:a.startDate||null,toolTipText:"If this is populated, cycle time will only be shown for artifacts that transitioned into the selected Cycle End State AFTER this date.",listeners:{scope:this,select:this.updateCycleTimeParameters}},{xtype:"rallydatefield",fieldLabel:"to",itemId:"dtTo",labelAlign:"right",labelSeparator:"",labelWidth:15,width:165,value:a.endDate||null,toolTipText:"If this is populated, cycle time will only be shown for artifacts that transitioned into the selected Cycle End State BEFORE this date.",listeners:{scope:this,select:this.updateCycleTimeParameters}}]}),this.down("#cb-fromState").on("select",this._updateToState,this);var d=this.down("#cb-StateField");d.on("ready",this._updateStateDropdowns,this),d.on("select",this._updateStateDropdowns,this),this._updateStateDropdowns(d),this.updateCycleTimeParameters()},clear:function(){this._getFromStateCombo().setValue(null)},getState:function(){var a=this.getCycleTimeParameters();return a.cycleStates&&Ext.isArray(a.cycleStates)&&(a.cycleStates=a.cycleStates.join(",")),a},_getStateFieldCombo:function(){return this.down("#cb-StateField")||null},_getFromStateCombo:function(){return this.down("#cb-fromState")||null},_getToStateCombo:function(){return this.down("#cb-toState")||null},applyState:function(a){a&&a.cycleStates&&!Ext.isArray(a.cycleStates)&&(a.cycleStates=a.cycleStates.split(",")),this._loadModels(a)},_updateToState:function(a){var b=this.down("#cb-toState");if(b&&b.setDisabled(!0),a&&a.getValue()&&a.getRecord()&&b){var c=[],d=a.getValue();Ext.Array.each(a.getStore().getRange(),function(a){(d===a.get("value")||c.length>0)&&c.push(a.getData())}),b.setDisabled(!1),b.bindStore(Ext.create("Rally.data.custom.Store",{data:c})),this.updateCycleTimeParameters()}},hasValidCycleTimeParameters:function(){var a=this.down("#cb-fromState")&&this.down("#cb-fromState").getValue(),b=this.down("#cb-toState")&&this.down("#cb-toState").getValue();return a&&b?!0:!1},getCycleTimeParameters:function(){var a=this._getStateFieldCombo()&&this._getStateFieldCombo().getValue()||null,b=this._getFromStateCombo()&&this._getFromStateCombo().getValue()||null,c=this._getToStateCombo()&&this._getToStateCombo().getValue()||null,d=this.down("#btReady")&&this.down("#btReady").pressed||!1,e=this.down("#btBlocked")&&this.down("#btBlocked").pressed||!1,f=this.down("#dtFrom")&&this.down("#dtFrom").getValue()||null,g=this.down("#dtTo")&&this.down("#dtTo").getValue()||null,h=this.down("#cb-fromState")&&this.down("#cb-fromState").getStore().getRange()||[];return h=Ext.Array.map(h,function(a){return a.get("value")}),h=_.uniq(h),{cycleStateField:a,cycleStartState:b,cycleEndState:c,showReady:d,showBlocked:e,startDate:f,endDate:g,cycleStates:h}},updateCycleTimeParameters:function(){this.saveState(),this.hasValidCycleTimeParameters()?this.fireEvent("parametersupdated",this.getCycleTimeParameters()):this.fireEvent("parametersupdated",{})},_isCycleTimeField:function(a){var b=["State","ScheduleState","FlowState"];if(a.hidden)return!1;if(Ext.Array.contains(b,a.name))return!0;if(a.readOnly)return!1;var c=["STATE","STRING"],d=a&&a.attributeDefinition;return d&&d.Constrained&&Ext.Array.contains(c,d.AttributeType)?!0:!1},_toggleButton:function(a,b){b?(a.removeCls("secondary"),a.addCls("primary")):(a.removeCls("primary"),a.addCls("secondary")),this.updateCycleTimeParameters()},_updateStateDropdowns:function(a){var b=this.down("#cb-fromState"),c=this.down("#cb-toState"),d=c&&c.getValue(),e=b&&b.getValue();b&&b.setDisabled(!0),c&&c.setDisabled(!0);var f=Ext.create("Rally.data.custom.Store",{data:[]});if(c.bindStore(f),a&&a.getValue()&&a.getRecord()){var g=a.model,h=[];"ScheduleState"!==a.getValue()&&h.push({value:CArABU.technicalservices.CycleTimeCalculator.noStateText}),g.getField(a.getValue()).getAllowedValueStore().load({callback:function(a,f){Ext.Array.each(a,function(a){h.push({value:a.get("StringValue")})});var g=Ext.create("Rally.data.custom.Store",{data:h});b.bindStore(g),b.setDisabled(!1),e&&b.setValue(e),c.bindStore(g),c.setDisabled(!1),d&&c.setValue(d),this.updateCycleTimeParameters()},scope:this})}}}),Ext.define("CArABU.technicalservices.Exporter",{singleton:!0,saveCSVToFile:function(a,b,c){void 0===c&&(c={type:"text/csv;charset=utf-8"}),this.saveAs(a,b,c)},saveAs:function(a,b){if(Ext.isIE9m)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});var c=null;try{c=new Blob([a],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"==d.name&&(bb=new BlobBuilder,bb.append([a]),c=bb.getBlob("text/plain"))}if(!c)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."});var e=b;if(Ext.isIE10p)return void window.navigator.msSaveOrOpenBlob(c,e);var f=this.createObjectURL(c);if(f){var g=document.createElement("a");"download"in g?g.download=e:g.target="_blank",g.innerHTML="Download File",g.href=f,Ext.isChrome||(g.onclick=this.destroyClickedElement,g.style.display="none",document.body.appendChild(g)),g.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(a){return window.webkitURL?window.webkitURL.createObjectURL(a):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null},destroyClickedElement:function(a){document.body.removeChild(a.target)}}),Ext.define("CA.technicalservices.FieldPicker",{alias:"widget.fieldpickerbutton",extend:"Rally.ui.Button",requires:["Rally.ui.popover.Popover","Rally.ui.Button","Rally.ui.picker.FieldPicker","Ext.state.Manager"],toolTipConfig:{html:"Show Columns",anchor:"top"},iconCls:"icon-add-column",cls:"field-picker-btn secondary rly-small",alwaysSelectedValues:["FormattedID","Name"],fieldBlackList:[],fieldPickerConfig:{},buttonConfig:{},modelNames:[],rankingEnabled:!1,margin:"3 9 0 0",constructor:function(a){this.config=_.merge({},this.config||{},a||{}),this.callParent([a])},initComponent:function(){if(this.models)return this.on("click",this._createPopover,this),void this.callParent(arguments);if(this.context&&this.modelNames&&this.modelNames.length>0)Rally.data.ModelFactory.getModels({types:this.modelNames,context:this.context,success:function(a){console.log("models"),this.models=a},failure:function(a){console.log("failedparam")},scope:this}),this.on("click",this._createPopover,this);else{this.iconCls="icon-none";var a="Please update the CA.technicalservices.FieldPicker configuration with modelNames and context";this.toolTipConfig={html:'<div style="color:red;">'+a+"</div>"},this.on("click",function(){Rally.ui.notify.Notifier.showError({message:a})})}this.callParent(arguments)},getFields:function(){return this._fields||this.alwaysSelectedValues},_getPickerConfig:function(){var a;return a=_.extend({value:this._fields,fieldBlackList:this.fieldBlackList,alwaysSelectedValues:this.alwaysSelectedValues,context:this.context},this.fieldPickerConfig)},_createPopover:function(a){var b=a.getEl();this.popover=Ext.create("Rally.ui.popover.Popover",{target:b,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:this.getTitle(),listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Apply",cls:"field-picker-apply-btn primary rly-small",listeners:{click:function(){this._onApply(this.popover)},scope:this}},{xtype:"rallybutton",text:"Cancel",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[_.extend({xtype:"rallyfieldpicker",cls:"field-picker",itemId:"fieldpicker",modelTypes:this._getModelTypes(),alwaysExpanded:!0,width:200,emptyText:"Search",selectedTextLabel:"Selected",availableTextLabel:"Available",listeners:{specialkey:function(a,b){b.getKey()===b.ESC&&this.popover.close()},scope:this}},this._getPickerConfig())]})},_getModelTypes:function(){return _.pluck(this._getModels(),"typePath")},_getModels:function(){return _.reduce(this.models,function(a,b){return"artifact"===b.typePath?a=a.concat(b.getArtifactComponentModels()):a.push(b),a},[])},getTitle:function(){return"Show Columns"},updateFields:function(a,b){this._fields=a,this.popover&&this.popover.down("rallyfieldpicker")&&this.popover.down("rallyfieldpicker").setValue(a.join(",")),this.saveState()},getState:function(){return{fields:this._fields}},applyState:function(a){a&&(this._fields=a.fields)},_onApply:function(a){var b=a.down("rallyfieldpicker"),c=_.map(b.getValue(),function(a){return a.get("name")});this.updateFields(c),a.close(),this.fireEvent("fieldsupdated",c)}}),Ext.define("Rally.ui.LeftRight",{alias:"widget.rallyleftright",extend:"Ext.container.Container",cls:"rui-leftright",defaults:{xtype:"container"},items:[{itemId:"left",cls:"rly-left"},{itemId:"right",cls:"rly-right"}],getLeft:function(){return this.down("#left")},getRight:function(){return this.down("#right")}}),Ext.apply(Ext.data.SortTypes,{asUser:function(a){return Ext.isString(a)?a:a&&a.DisplayName||a._refObjectName}}),Ext.override(Rally.ui.grid.TreeGrid,{_mergeColumnConfigs:function(a,b){var c=_.map(a,function(a){var c=_.find(b,{dataIndex:this._getColumnName(a)});return c?this._getColumnConfigFromColumn(c):a},this);return c=c.concat(this.config.derivedColumns)},_getColumnConfigsBasedOnCurrentOrder:function(a){var b=_(this.headerCt.items.getRange()).map(function(b){return _.contains(a,b.dataIndex)?b.dataIndex:_.find(a,{xtype:b.xtype,text:b.text})}).compact().value();return b},_restoreColumnOrder:function(a){var b=this._getColumnConfigsBasedOnCurrentOrder(a),c=_.filter(a,function(a){return Ext.isString(a)?!0:_.find(b,{dataIndex:a.dataIndex})&&_.find(b,{text:a.text})?!1:!0});return console.log("added columns",c,a,b),b.concat(c)},_applyStatefulColumns:function(a){this.alwaysShowDefaultColumns&&_.each(this.columnCfgs,function(b){_.any(a,{dataIndex:this._getColumnName(b)})||a.push(b)},this),this.config&&this.config.derivedColumns?this.columnCfgs=a.concat(this.config.derivedColumns):this.columnCfgs=a}}),Ext.define("CArABU.technicalservices.CycleTimeData.Settings",{singleton:!0,getFields:function(a){return[{xtype:"rallynumberfield",fieldLabel:"Max Export Limit",name:"exportLimit",labelAlign:"right",labelWidth:100,minValue:10,maxValue:1e4},{xtype:"textarea",fieldLabel:"Query",name:"queryFilter",anchor:"100%",cls:"query-field",margin:"0 70 0 0",labelAlign:"right",labelWidth:100,plugins:[{ptype:"rallyhelpfield",helpId:194},"rallyfieldvalidationui"],validateOnBlur:!1,validateOnChange:!1,validator:function(a){try{return a&&Rally.data.wsapi.Filter.fromQueryString(a),!0}catch(b){return b.message}}}]}}),Ext.define("CArABU.technicalservices.CycleTimeTemplateColumn",{extend:"Ext.grid.column.Template",alias:["widget.cycletimetemplatecolumn"],align:"right",initComponent:function(){var a=this;Ext.QuickTips.init(),a.tpl=new Ext.XTemplate('<tpl><div data-qtip="{[this.getTooltip(values)]}" style="cursor:pointer;text-align:right;">{[this.getCycleTime(values)]}</div></tpl>',{getCycleTime:function(a){var b=a&&a.cycleTime;return b>=0?b:"--"},getTooltip:function(a){var b="";return a&&a.startDate&&(b=Ext.String.format("Start: {0}",Rally.util.DateTime.format(a.startDate,"Y-m-d h:i:s a"))),a&&a.cycleTime&&a.endDate&&(b=Ext.String.format("{0} <br/>{1}</br>End: {2}",a.cycleTime,b,Rally.util.DateTime.format(a.endDate,"Y-m-d h:i:s a"))),b}}),a.hasCustomRenderer=!0,a.callParent(arguments)},defaultRenderer:function(a,b,c){var d=Ext.apply({},c.get("cycleTimeData"));return this.tpl.apply(d)}}),Ext.define("CArABU.technicalservices.TimeTemplateColumn",{extend:"Ext.grid.column.Template",alias:["widget.timetemplatecolumn"],align:"right",initComponent:function(){var a=this;Ext.QuickTips.init(),a.tpl=new Ext.XTemplate('<tpl><div data-qtip="{[this.getTooltip(values)]}" style="cursor:pointer;text-align:right;">{[this.getCurrentIcon(values)]}{[this.getTime(values)]}</div></tpl>',{stateName:a.stateName,dataType:a.dataType,stateValue:a.stateValue,getTime:function(a){return CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(a,this.stateName,this.stateValue,"--")},getCurrentIcon:function(a){if(a.currentValue&&(a.currentValue===!0||a.currentValue===this.stateValue)){var b="icon-square",c="#005eb8";return"Blocked"===this.stateName&&(b="icon-blocked",c="#b81b10"),"Ready"===this.stateName&&(b="icon-ready",c="#8dc63f"),Ext.String.format('<div class="{0}" style="color:{1}"></div>',b,c)}return""},getTooltip:function(a){var b=a[this.stateName];if(b&&this.stateValue&&(b=b[this.stateValue]),!b||0===b.length)return"";var c=this.stateValue||"[No State]";("Blocked"===this.stateName||"Ready"===this.stateName)&&(c="true");var d=Ext.String.format("{0}: {1}<br/>",this.stateName,c);return Ext.Array.each(b,function(a){var b=a&&a.length>0&&Rally.util.DateTime.format(a[0],"Y-m-d h:i:s a")||"",c=a&&a.length>1&&Rally.util.DateTime.format(a[1],"Y-m-d h:i:s a")||"current";b.length>0&&(d+=Ext.String.format("{0} - {1}<br/>",b,c))}),d}}),a.hasCustomRenderer=!0,a.callParent(arguments)},defaultRenderer:function(a,b,c){var d=Ext.apply({},c.get(this.dataType));return d.currentValue=c.get(this.stateName),this.tpl.apply(d)}}),Ext.define("CA.technicalservices.Utility",{singleton:!0,loadModels:function(a,b){return Rally.data.ModelFactory.getModels({types:a,context:b})}}),Ext.define("cycle-time-data-app",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10,labelAlign:"right"},instructions:'Please click the Filter icon <div class="icon-filter"></div> to define filters for the current data set to calculate historical cycle time data for.<br/>Please click the Cycle Time button <div class="icon-history"></div> to add criteria for calculating cycle time.  <br/>After parameters have been selected, click <div class="icon-refresh"></div><b>Update</b> to load the data.<br/><br/>If a Cycle Time State, Cycle Time State From and To are not defined, Cycle Time data will not be calculated.  <br/>Cycle End Date From and To are optional.  If Cycle End Date From and To are selected, then only artifacts that transitioned into or past the Cycle Time To State during the selected date range will be displayed. <br/><br/>More detailed app information can be found in the <a href="https://github.com/RallyTechServices/cycle-time-apps-2.1/blob/master/cycle-time-data-app/README.md" target="_blank">Github README file here</a> ',items:[{xtype:"container",itemId:"top_box",layout:"hbox",items:[{xtype:"container",itemId:"artifact_box"},{xtype:"container",itemId:"granularity_box"}]},{xtype:"container",itemId:"selector_box_parent",layout:"hbox",items:[{xtype:"container",itemId:"selector_box",layout:"hbox",flex:1},{xtype:"container",itemId:"selector_box_right",layout:"hbox",cls:"rly-right"}]},{xtype:"container",itemId:"filter_box",flex:1},{xtype:"container",itemId:"cycletime_box",flex:1},{xtype:"container",itemId:"message_box",flex:1,height:45,tpl:'<tpl><div class="no-data-container"><div class="secondary-message">{message}</div></div></tpl>'},{xtype:"container",itemId:"total_box"},{xtype:"container",itemId:"grid_box"}],integrationHeaders:{name:"cycle-time-data-app"},config:{defaultSettings:{artifactType:"HierarchicalRequirement",queryFilter:"",granularity:"day",precision:2,exportLimit:1e3}},exportDateFormat:"m/d/Y h:i:s",_gridConfig:{},launch:function(){this.logger.log("Launch Settings",this.getSettings());var a=this,b=2e3;a.setLoading(!0),a._getFlowStates(1,20,!0).then({success:function(c){console.log("Total Count:",c);var d=[];for(i=0;i<Math.ceil(c/b);i++)d.push(a._getFlowStates(i*b+1,b,!1));Deft.Promise.all(d).then({success:function(b){var c=_.flatten(b);console.log(c),a.flow_states={},_.each(c,function(b){a.flow_states[b.ObjectID]=b.Name}),console.log(a.flow_states),CArABU.technicalservices.CycleTimeCalculator.flowStates=a.flow_states,a.setLoading(!1),a.addArtifactPicker()},failure:function(b){a.showErrorNotification(b),a.setLoading(!1),deferred.reject(b)},scope:a})},scope:a})},_getFlowStates:function(a,b,c){var d=Ext.create("Deft.Deferred"),e="/slm/webservice/v2.0/FlowState?fetch=Name,ObjectID&start="+a+"&pagesize="+b;return console.log(e),Ext.Ajax.request({url:e,method:"GET",success:function(a){var a=JSON.parse(a.responseText),b=[],e=0;c?(e=a&&a.QueryResult&&a.QueryResult.TotalResultCount||0,d.resolve(e)):(b=a&&a.QueryResult&&a.QueryResult.Results||[],d.resolve(b))},failure:function(a){console.log(a),me.setLoading(!1)}}),d.promise},showErrorNotification:function(a){a||(a="Error during execution.  See logs for details."),Rally.ui.notify.Notifier.showError({message:a})},addArtifactPicker:function(){this.getArtifactBox().removeAll(),this.getGranularityBox().removeAll();var a=[{property:"TypePath",operator:"contains",value:"PortfolioItem/"},{property:"TypePath",value:"Defect"},{property:"TypePath",value:"HierarchicalRequirement"}];a=Rally.data.wsapi.Filter.or(a),
this.getArtifactBox().add({xtype:"rallycombobox",itemId:"cb-ArtifactType",name:"artifactType",stateful:!0,stateId:"artifact_type",storeConfig:{model:"TypeDefinition",filters:a,remoteFilter:!0,autoLoad:!0},fieldLabel:"Artifact Type",allowBlank:!1,labelAlign:"right",labelWidth:150,width:300,valueField:"TypePath",displayField:"DisplayName",listeners:{scope:this,change:function(a){this.addSelectors()}}}),this.getGranularityBox().add({xtype:"radiogroup",itemId:"granularity",fieldLabel:"Granularity",labelAlign:"right",stateful:!0,stateId:"granularity_picker",layout:"hbox",labelWidth:100,width:500,items:[{boxLabel:"Week",name:"granularity",inputValue:"week"},{boxLabel:"Day",name:"granularity",inputValue:"day",checked:!0},{boxLabel:"Hour",name:"granularity",inputValue:"hour"},{boxLabel:"Minute",name:"granularity",inputValue:"minute"}],listeners:{change:function(){this.setUpdateButtonUpdateable(!0)},scope:this}})},addSelectors:function(){this.getSelectorBox().removeAll(),this.getCycleTimeBox().removeAll(),this.getFilterBox().removeAll(),this.getMessageBox().update({message:this.instructions});var a=this.getSelectorBox().add({xtype:"fieldpickerbutton",modelNames:this.getModelNames(),context:this.getContext(),stateful:!0,stateId:"grid-columns"});a.on("fieldsupdated",this.updateGridFields,this);this.getSelectorBox().add({xtype:"rallyinlinefilterbutton",modelNames:this.getModelNames(),context:this.getContext(),margin:"3 9 0 0",stateful:!0,stateId:"grid-filters-1",inlineFilterPanelConfig:{quickFilterPanelConfig:{addQuickFilterConfig:{whiteListFields:["Milestones","Tags"]}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:["Milestones","Tags"]}}}},listeners:{inlinefilterready:this.addInlineFilterPanel,inlinefilterchange:this.updateGridFilters,scope:this}}),this.getSelectorBox().add({xtype:"cycletimepickerbutton",modelNames:this.getModelNames(),context:this.getContext(),margin:"3 9 0 0",listeners:{cycletimepickerready:this.addCycleTimePanel,scope:this,cycletimeparametersupdated:this.updateCycleTimeParameters}});this.getSelectorBoxRight().removeAll();var b=this.getSelectorBoxRight().add({xtype:"rallybutton",itemId:"btUpdate",text:"Update",width:100,margin:"3 9 0 0"});b.on("click",this.updateGrid,this),this.getSelectorBoxRight().add({xtype:"rallybutton",style:{"float":"right"},cls:"secondary rly-small",margin:"3 9 0 0",frame:!1,itemId:"actions-menu-button",iconCls:"icon-export",listeners:{click:this.showExportMenu,scope:this}}),this.getSelectorBoxRight().add({xtype:"rallybutton",iconCls:"icon-help",cls:"help-button",margin:"0 9 0 25",listeners:{click:this.showInstructionsDialog,scope:this}})},showInstructionsDialog:function(a){var b=a.getEl();this.popover=Ext.create("Rally.ui.popover.Popover",{target:b,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:"Cycle Time App Instructions",width:Math.min(this.getWidth(),400),listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Close",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[{xtype:"container",html:this.instructions}]})},showExportMenu:function(a){var b=Ext.widget({xtype:"rallymenu",items:[{text:"Export Summary...",handler:function(){this.exportData(!1,!0)},scope:this},{text:"Export with Timestamps...",handler:function(){this.exportData(!0,!1)},scope:this},{text:"Export Summary and Timestamps...",handler:function(){this.exportData(!0,!0)},scope:this}]});b.showBy(a.getEl()),a.toolTip&&a.toolTip.hide()},getSelectorBoxRight:function(){return this.down("#selector_box_right")},getFilterBox:function(){return this.down("#filter_box")},getCycleTimeBox:function(){return this.down("#cycletime_box")},addInlineFilterPanel:function(a){this.logger.log("addInlineFilterPanel",a),this.getFilterBox().add(a)},addCycleTimePanel:function(a){this.logger.log("addCycleTimePanel",a),this.getCycleTimeBox().add(a)},updateGridFields:function(a){this.logger.log("updateGridFields",a),this._gridConfig.fields=a,this.updateGrid()},setUpdateButtonUpdateable:function(a){var b=this.down("#btUpdate");b&&(a?(b.setDisabled(!1),b.setIconCls("icon-refresh")):(b.setDisabled(!0),b.setIconCls("")))},updateGridFilters:function(a){this.logger.log("updateGridFilters",a.getTypesAndFilters()),this._gridConfig.filters=a.getTypesAndFilters(),this.getSelectorBox().doLayout(),this.setUpdateButtonUpdateable(!0)},updateCycleTimeParameters:function(a){this.logger.log("updateCycleTimeParameters",a.getCycleTimeParameters()),this._gridConfig.cycleTimeParameters=a.getCycleTimeParameters(),this.setUpdateButtonUpdateable(!0)},calculateCycleTime:function(){return this.down("cycletimepickerbutton")&&this.down("cycletimepickerbutton").hasValidCycleTimeParameters()||!1},getMessageBox:function(){return this.down("#message_box")},updateMessageBox:function(a,b){b&&(a=Ext.String.format('<span style="color:{0};">{1}</span>',b,a)),this.getMessageBox().update({message:a})},updateGrid:function(){CArABU.technicalservices.CycleTimeCalculator.startDate=this.getStartDate(),CArABU.technicalservices.CycleTimeCalculator.endDate=this.getEndDate(),CArABU.technicalservices.CycleTimeCalculator.precision=this.getSetting("precision"),CArABU.technicalservices.CycleTimeCalculator.granularity=this.down("#granularity")&&this.down("#granularity").getValue()&&this.down("#granularity").getValue().granularity,this.getGridBox().removeAll(),this.down("#total_box").removeAll(),this.updateMessageBox(),this.setUpdateButtonUpdateable(!1),this.setLoading("Loading Current Data..."),this.fetchWsapiArtifactData().then({success:this.buildCycleGrid,failure:this.showErrorNotification,scope:this}).always(function(){this.setLoading(!1)},this)},buildCycleGrid:function(a){this.logger.log("buildCycleGrid",a),a&&a.length>0&&(this.calculateCycleTime()?(this.setLoading("Loading Historical data..."),this.fetchHistoricalData(a).then({success:this.addGrid,failure:this.showErrorNotification,scope:this}).always(function(){this.setLoading(!1)},this)):this.addGrid(a))},addGrid:function(a){this.logger.log("addGrid",a.length);var b=a.length>0&&a[0].getFields()||void 0;this.suspendLayouts(),this.addTotals(a);var c=Ext.create("Rally.data.custom.Store",{data:a,fields:b,pageSize:25});this.getGridBox().add({xtype:"rallygrid",itemId:"main-grid",store:c,columnCfgs:this.getColumnCfgs(a[0]),scroll:"vertical",emptyText:'<div class="no-data-container"><div class="secondary-message">No data was found for the selected current filters, cycle time parameters and project scope.</div></div>',listeners:{load:function(a,b){console.log("Grid load",a)}}}),this.resumeLayouts(!0)},addTotals:function(a){console.log("Add Totals",a);var b=this,c={Name:"Totals"},d={},e=this.getCycleStates(),f=this.getStateField(),g=this.getIncludeBlocked(),h=this.getIncludeReady();this.getPreviousStates(),this.getEndStates();c.CycleTime=0,d.CycleTime=0,c["Time To Market"]=0,d["Time To Market"]=0,g&&(c[TsConstants.LABEL.IN_BLOCKED]=0,d[TsConstants.LABEL.IN_BLOCKED]=0),h&&(c[TsConstants.LABEL.IN_READY]=0,d[TsConstants.LABEL.IN_READY]=0);for(var i=0;i<e.length&&(""==e[i]||(c[e[i]]=0,d[e[i]]=0,e[i]!=this.getToStateValue()));i++);for(var j=0;j<a.length;j++){var k=a[j],l=0,m=k.get("timeInStateData");if(k.get("cycleTimeData")&&k.get("cycleTimeData").cycleTime&&0!=Number(k.get("cycleTimeData")&&k.get("cycleTimeData").cycleTime)&&(c.CycleTime+=Number(k.get("cycleTimeData")&&k.get("cycleTimeData").cycleTime),d.CycleTime++,d[TsConstants.LABELS.TIME_TO_MARKET]++),g){var n=Number(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(m,"Blocked",null,""));NaN!=n&&0!=Number(n)&&(c[TsConstants.LABEL.IN_BLOCKED]+=n,d[TsConstants.LABEL.IN_BLOCKED]++)}if(h){var o=Number(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(m,"Ready",null,""));NaN!=o&&0!=o&&(c[TsConstants.LABEL.IN_READY]+=o,d[TsConstants.LABEL.IN_READY]++)}for(var p=!1,i=0;i<e.length;i++)if(m&&""!=e[i]){e[i]==this.getFromStateValue()&&(p=!0);var q=Number(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(m[f],e[i],k.get(e[i]),""));if(NaN!=q&&0!=q&&(c[e[i]]+=q,d[e[i]]++,p&&e[i]!=this.getToStateValue()&&(l+=q,c[TsConstants.LABELS.TIME_TO_MARKET]+=q)),e[i]==this.getToStateValue())break}k.set(TsConstants.LABELS.TIME_TO_MARKET,l)}var r={};_.each(c,function(a,b){r[b]=d[b]>0?c[b]/d[b]:0}),r.Name="Averages",d.Name="Counts",console.log("totals/counts",c,d,r);var s=[];_.each(Ext.Object.getKeys(c),function(a){"Name"==a?s.push({text:"",dataIndex:a,flex:1}):s.push({text:a,dataIndex:a,flex:1,renderer:function(a){return Ext.util.Format.round(a,2)}})}),b.down("#total_box").removeAll(),b.down("#total_box").add({xtype:"rallygrid",showPagingToolbar:!1,showRowActionsColumn:!1,editable:!1,store:Ext.create("Rally.data.custom.Store",{data:[c,r,d]}),border:1,title:"Summary in "+CArABU.technicalservices.CycleTimeCalculator.granularity+"(s)",titleAlign:"center",columnCfgs:s})},fetchWsapiArtifactData:function(){var a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.artifact.Store",{models:this.getModelNames(),limit:this.getExportLimit(),fetch:this.getCurrentFetchList(),filters:this.getWsapiArtifactFilters(),pageSize:Math.min(this.getExportLimit(),1e3)}).load({callback:function(b,c){if(this.logger.log("fetchWsapiArtifactData",b.length,c,b),c.wasSuccessful()){var d=c&&c.resultSet&&c.resultSet.total;this.logger.log("count",d,this.getExportLimit()),d>this.getExportLimit()?(this.updateMessageBox(Ext.String.format("A total of {0} current records were found, but only {1} can be fetched for performance reasons.  Please refine the advanced filters (current, not Cycle Time) to fetch less data.",d,this.getExportLimit()),Rally.util.Colors.brick),a.resolve(null)):(this.updateMessageBox(Ext.String.format("{0} current records found.",d)),a.resolve(b))}else a.reject("Unable to get artifact count:  "+c.error.errors.join(","))},scope:this}),a},getWsapiArtifactFilters:function(){var a=this._gridConfig&&this._gridConfig.filters&&this._gridConfig.filters.filters[0]||null;if(this.getQueryFilter()&&(a=a?a.and(this.getQueryFilter()):this.getQueryFilter()),this.logger.log("getWsapiArtifactFilters",a),this.calculateCycleTime()&&this.getShowOnlyCompletedCycles()){var b=this.getCycleStates(),c=[],d=this.getStateField(),e=this.getToStateValue(),f=new RegExp("PortfolioItem/","i");f.test(this.getModelNames()[0])&&"State"===d&&(d="State.Name"),"FlowState"===d&&(d="FlowState.Name"),Ext.Array.each(b,function(a){(a===e||c.length>0)&&c.push({property:d,value:a})}),c=Rally.data.wsapi.Filter.or(c),a=a?a.and(c):c}return a=a||[],this.logger.log("getWsapiArtifactFilters",a.toString()),a},getStartDate:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.startDate?this._gridConfig.cycleTimeParameters.startDate:null},getEndDate:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.endDate?this._gridConfig.cycleTimeParameters.endDate:null},getCycleStates:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleStates||[]},getGridColumns:function(){return this.down("fieldpickerbutton")&&this.down("fieldpickerbutton").getFields()},getPreviousStates:function(a){for(var b=this.getCycleStates(),c=[null],d=0;d<b.length;d++){var e=b[d];e===a?d=b.length:e&&e.length>0&&c.push(e)}return this.logger.log("getPreviousStates",c),c},getEndStates:function(a){a||(a=this.getToStateValue());var b=this.getCycleStates(),c=[];this.logger.log("getEndStates",a,b);for(var d=b.length-1;d>0;d--){var e=b[d];c.push(e),e===a&&(d=0)}return c},getCurrentFetchList:function(){var a=Ext.Array.merge(this.getGridColumns(),["ObjectID"]);return this.getStateField()&&Ext.Array.merge(this.getStateField(),a),this.getIncludeBlocked()&&Ext.Array.merge("Blocked",a),this.getIncludeReady()&&Ext.Array.merge(a,"Ready"),this.logger.log("getCurrentFetchList",a),a},getShowOnlyCompletedCycles:function(){return!0},getWsapiArtifactCount:function(a){a.limit=1,a.fetch=["ObjectID"],a.pageSize=1;var b=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.artifact.Store",a).load({callback:function(a,c){if(this.logger.log("getWsapiArtifactCount",c),c.wasSuccessful()){var d=c&&c.resultSet&&c.resultSet.total;b.resolve(d)}else b.reject("Unable to get aritfact count:  "+c.error.errors.join(","))},scope:this}),b},getExportLimit:function(){return this.getSetting("exportLimit")||1e3},getStateValueArray:function(){var a=_.map(this.getFromStateCombo().getStore().getRange(),function(a){return a.get("value")},this);return Ext.Array.remove(a,""),a},fetchHistoricalData:function(a){var b=Ext.create("Deft.Deferred");if(this.logger.log("fetchHistoricalData",a),this.calculateCycleTime()&&a.length>0){this.setLoading(Ext.String.format("Loading historical data for {0} artifacts.",a.length));var c=this.getIncludeBlocked(),d=this.getIncludeReady(),e=this.getFromStateValue(),f=this.getToStateValue(),g=this.getStateField(),h=this.getCycleStates();this.logger.log("stateValues",h),Ext.create("CArABU.technicalservices.CycleTimeDataStore",{stateField:g,stateValues:h,includeReady:d,includeBlocked:c,fromState:e,toState:f,startDate:this.getStartDate(),endDate:this.getEndDate()}).load(a).then({success:function(c){this.updateMessageBox(Ext.String.format("Displaying {0} of {1} records with relevant cycle time data.",c.length,a.length)),b.resolve(c)},failure:function(a){b.reject(a)},scope:this}).always(function(){this.setLoading(!1)},this)}else b.resolve(a);return b},updateHistoricalData:function(a){this.logger.log("updateHistoricalData",a)},getCycleTimeColumnHeader:function(){return Ext.String.format("Cycle time from {0} to {1} ({2}s)",this.getFromStateValue(),this.getToStateValue(),CArABU.technicalservices.CycleTimeCalculator.granularity)},getTimeToMarketColumnHeader:function(){return Ext.String.format("Time to Market from {0} to {1} ({2}s)",this.getFromStateValue(),this.getToStateValue(),CArABU.technicalservices.CycleTimeCalculator.granularity)},getCycleTimeStartColumnHeader:function(){return"Cycle Time Start Date"},getCycleTimeEndColumnHeader:function(){return"Cycle Time End Date"},getTimeInStateColumnHeader:function(a){return Ext.String.format("Time in {0} ({1}s)",a||"[No State]",CArABU.technicalservices.CycleTimeCalculator.granularity)},getHistoricalDataColumns:function(){var a=[],b=this.getToStateValue(),c=this.getFromStateValue();return c&&b&&(a.push({xtype:"cycletimetemplatecolumn",text:this.getCycleTimeColumnHeader(),flex:1}),a.push({xtype:"cycletimetemplatecolumn",text:this.getTimeToMarketColumnHeader(),flex:1,renderer:function(a,b,c){return Ext.util.Format.round(c.get(TsConstants.LABELS.TIME_TO_MARKET),2)}})),this.getIncludeBlocked()&&a.push({xtype:"timetemplatecolumn",dataType:"timeInStateData",stateName:"Blocked",text:this.getTimeInStateColumnHeader("Blocked"),flex:1}),this.getIncludeReady()&&a.push({xtype:"timetemplatecolumn",dataType:"timeInStateData",stateName:"Ready",text:this.getTimeInStateColumnHeader("Ready"),flex:1}),c&&b&&Ext.Array.each(this.getCycleStates(),function(c){if(c&&c.length>0){var d=this.getTimeInStateColumnHeader(c);if(a.push({xtype:"timetemplatecolumn",dataType:"timeInStateData",stateName:this.getStateField(),stateValue:c,text:d,flex:1}),c===b)return!1}},this),this.logger.log("getHistoricalDataColumns",a),a},getColumnCfgs:function(a){var b=[];return Ext.Array.each(this.getCurrentFetchList(),function(c){if("ObjectID"!==c){if(a)var d=a.getField(c),e=Rally.ui.renderer.RendererFactory.getRenderTemplate(d),f={text:d.displayName,dataIndex:c,renderer:function(a,b,c){return e.apply(c.getData())}};else var f={text:c.replace("c_",""),dataIndex:c};"Name"===c&&(f.flex=1),b.push(f)}}),this.calculateCycleTime()&&(b=b.concat(this.getHistoricalDataColumns())),this.logger.log("getColumnCfgs",b),b},exportData:function(a,b){var c=this.down("#main-grid");if(!c)return void this.showErrorNotification("Cannot save export becuase there is no data displapyed to export.");var d=c.getStore().getTotalCount();this.logger.log("exportData",d);var e=c.getStore();this.getMessageBox().setLoading("Preparing Export File(s)..."),e.load({pageSize:d,limit:d,callback:function(c,d){if(this.getMessageBox().setLoading(!1),d.wasSuccessful()){var e=this.getColumnCfgs(c&&c[0]);this.saveExportFiles(c,e,a,b)}else this.logger.log("Error preparing export data",d),Rally.ui.notify.Notifier.showError("Error preparing export data:  "+d&&d.error&&d.error.errors.join(","))},scope:this})},saveExportFiles:function(a,b,c,d){if(d){var e=Ext.String.format("cycle-time-{0}.csv",Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s")),f=this.getExportSummaryCSV(a,b);CArABU.technicalservices.Exporter.saveCSVToFile(f,e)}if(c){var e=Ext.String.format("time-in-state-{0}.csv",Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s")),g=this.getExportTimestampCSV(a);CArABU.technicalservices.Exporter.saveCSVToFile(g,e)}},getExportTimestampCSV:function(a){return CArABU.technicalservices.CycleTimeCalculator.getExportTimestampCSV(a,this.exportDateFormat)},getExportSummaryCSV:function(a,b){var c=_.filter(b,function(a){return a.dataIndex||null}),d=_.map(c,function(a){return"ID"===a.text?"Formatted ID":a.text}),e=_.map(c,function(a){return a.dataIndex});this.logger.log("getExportSummaryCSV",d,e);var f=this.getCycleStates(),g=this.getStateField(),h=this.getIncludeBlocked(),i=this.getIncludeReady();d.push(this.getCycleTimeColumnHeader()),d.push(this.getCycleTimeStartColumnHeader()),d.push(this.getCycleTimeEndColumnHeader()),h&&d.push(this.getTimeInStateColumnHeader("Blocked")),i&&d.push(this.getTimeInStateColumnHeader("Ready")),Ext.Array.each(f,function(a){d.push(this.getTimeInStateColumnHeader(a))},this);for(var j=[d.join(",")],k=this.exportDateFormat,l=0;l<a.length;l++){for(var m=[],n=a[l],o=0;o<e.length;o++){var p=n.get(e[o]);if(Ext.isObject(p))if(p._tagsNameArray){var q=[];Ext.Array.each(p._tagsNameArray,function(a){q.push(a.Name)}),p=q.join(",")}else p=p._refObjectName;m.push(p||"")}var r=n.get("timeInStateData");m.push(n.get("cycleTimeData")&&n.get("cycleTimeData").cycleTime||"");var s=n.get("cycleTimeData")&&n.get("cycleTimeData").startDate||null,t=n.get("cycleTimeData")&&n.get("cycleTimeData").endDate||null,u=s&&Rally.util.DateTime.format(s,k)||"",v=t&&Rally.util.DateTime.format(t,k)||"";m.push(u),m.push(v),h&&m.push(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(r,"Blocked",null,"")),i&&m.push(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(r,"Ready",null,""));for(var w=0;w<f.length;w++)r?m.push(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(r[g],f[w],n.get(f[w]),"")):m.push("");m=_.map(m,function(a){return Ext.String.format('"{0}"',a.toString().replace(/"/g,'""'))}),j.push(m.join(","))}return j.join("\r\n")},loadWsapiRecords:function(a,b){var c=Ext.create("Deft.Deferred"),d={model:"Defect",fetch:["ObjectID"]};return Ext.create("Rally.data.wsapi.Store",Ext.Object.merge(d,a)).load({callback:function(a,d,e){e?b?c.resolve(d):c.resolve(a):c.reject("Problem loading: "+d.error.errors.join(". "))}}),c.promise},getQueryFilter:function(){var a=this.getSetting("queryFilter");return a&&a.length>0?Rally.data.wsapi.Filter.fromQueryString(a):null},getIncludeBlocked:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.showBlocked||!1},getIncludeReady:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.showReady||!1},getFromStateCombo:function(){return this.cycleTimeFromState},getToStateCombo:function(){return this.cycleTimeToState},getToStateValue:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleEndState||null},getFromStateValue:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleStartState||null},getStateField:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleStateField||null},getModelNames:function(){var a=this.down("#cb-ArtifactType").getValue();return this.logger.log("getModelNames",a),[a]||[]},getArtifactBox:function(){return this.down("#artifact_box")},getGranularityBox:function(){return this.down("#granularity_box")},getSelectorBox:function(){return this.down("#selector_box")},getGridBox:function(){return this.down("#grid_box")},getSettingsFields:function(){return CArABU.technicalservices.CycleTimeData.Settings.getFields(this.getSettings())},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},onSettingsUpdate:function(a){this.logger.log("onSettingsUpdate",a),this.addSelectors()}});

               Rally.launchApp('cycle-time-data-app', {
                   name: 'cycle-time-data-app'
               });
        });
    </script>

    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.rly-left {
    width: 75%;
}
.rly-right {
    width: 25%;
}
.warning {
    color:darkred;
}
.help-button {
    color:silver;
    background-color:white;
    font-size:14px;
}
    </style>

</head>
<body></body>
</html>