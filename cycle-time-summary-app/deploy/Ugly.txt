<!DOCTYPE html>
<html>
<head>
    <title>cycle-time-summary-app</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Fri Oct 20 2017 09:41:12 GMT-0700 (PDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Fri Oct 20 2017 09:41:12 GMT-0700 (PDT)";
        var STORY    = "F361";
        var BUILDER  = "rajan08";
        var CHECKSUM = 202861586223;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            var saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e=!a.externalHost&&"download"in d,f=function(c){var d=b.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)},g=a.webkitRequestFileSystem,h=a.requestFileSystem||g||a.mozRequestFileSystem,i=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},j="application/octet-stream",k=0,l=[],m=function(){for(var a=l.length;a--;){var b=l[a];"string"==typeof b?c().revokeObjectURL(b):b.remove()}l.length=0},n=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(f){i(f)}}},o=function(b,i){var m,o,p,q=this,r=b.type,s=!1,t=function(){var a=c().createObjectURL(b);return l.push(a),a},u=function(){n(q,"writestart progress write writeend".split(" "))},v=function(){(s||!m)&&(m=t(b)),o?o.location.href=m:window.open(m,"_blank"),q.readyState=q.DONE,u()},w=function(a){return function(){return q.readyState!==q.DONE?a.apply(this,arguments):void 0}},x={create:!0,exclusive:!1};return q.readyState=q.INIT,i||(i="download"),e?(m=t(b),d.href=m,d.download=i,f(d),q.readyState=q.DONE,void u()):(a.chrome&&r&&r!==j&&(p=b.slice||b.webkitSlice,b=p.call(b,0,b.size,j),s=!0),g&&"download"!==i&&(i+=".download"),(r===j||g)&&(o=a),h?(k+=b.size,void h(a.TEMPORARY,k,w(function(a){a.root.getDirectory("saved",x,w(function(a){var c=function(){a.getFile(i,x,w(function(a){a.createWriter(w(function(c){c.onwriteend=function(b){o.location.href=a.toURL(),l.push(a),q.readyState=q.DONE,n(q,"writeend",b)},c.onerror=function(){var a=c.error;a.code!==a.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(a){c["on"+a]=q["on"+a]}),c.write(b),q.abort=function(){c.abort(),q.readyState=q.DONE},q.readyState=q.WRITING}),v)}),v)};a.getFile(i,{create:!1},w(function(a){a.remove(),c()}),w(function(a){a.code===a.NOT_FOUND_ERR?c():v()}))}),v)}),v)):void v())},p=o.prototype,q=function(a,b){return new o(a,b)};return p.abort=function(){var a=this;a.readyState=a.DONE,n(a,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,a.addEventListener("unload",m,!1),q.unload=function(){m(),a.removeEventListener("unload",m,!1)},q}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&null!==module?module.exports=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("Rally.technicalservices.FileUtilities",{singleton:!0,logger:new Rally.technicalservices.Logger,saveCSVToFile:function(a,b,c){void 0==c&&(c={type:"text/csv;charset=utf-8"});var d=new Blob([a],c);saveAs(d,b)},saveTextAsFile:function(a,b){var c=new Blob([a],{type:"text/plain"}),d=b,e=document.createElement("a");e.download=d,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(c):(e.href=window.URL.createObjectURL(c),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},destroyClickedElement:function(a){document.body.removeChild(a.target)},convertDataArrayToCSVText:function(a,b){var c="";return Ext.each(Object.keys(b),function(a){c+=b[a]+","}),c=c.replace(/,$/,"\n"),Ext.each(a,function(a){Ext.each(Object.keys(b),function(b){c+=a[b]?"object"==typeof a[b]?a[b].FormattedID?Ext.String.format('"{0}",',a[b].FormattedID):a[b].Name?Ext.String.format('"{0}",',a[b].Name):isNaN(Date.parse(a[b]))?Ext.String.format('"{0}",',a[b].toString()):Ext.String.format('"{0}",',Rally.util.DateTime.formatWithDefaultDateTime(a[b])):Ext.String.format('"{0}",',a[b]):","},this),c=c.replace(/,$/,"\n")},this),c},_getCSVFromWsapiBackedGrid:function(a){for(var b=Ext.create("Deft.Deferred"),c=Ext.create("Rally.data.wsapi.Store",{fetch:a.getStore().config.fetch,filters:a.getStore().config.filters,model:a.getStore().config.model,limit:1/0,pageSize:1/0}),d=a.columns,e=this._getHeadersFromGrid(a),f=(this._getColumnNamesFromGrid(a),a.getStore().getTotalCount()),g=a.getStore().pageSize,h=Math.ceil(f/g),i=[],j=1;h>=j;j++)i.push(this.loadStorePage(a,c,d,j,h));return Deft.Promise.all(i).then({success:function(a){var c=[];c.push('"'+e.join('","')+'"'),_.each(a,function(a){_.each(a,function(a){c.push(a)})}),c=c.join("\r\n"),b.resolve(c),Rally.getApp().setLoading(!1)}}),b.promise},_getCSVFromCustomBackedGridWithPaging:function(a){var b=Ext.create("Deft.Deferred"),c=Ext.create("Rally.data.custom.Store",{model:a.getStore().config.model,filters:a.getStore().config.filters,limit:1/0,pageSize:1/0}),d=a.columns,e=this._getHeadersFromGrid(a),f=(this._getColumnNamesFromGrid(a),a.getStore().getTotalCount()),g=a.getStore().pageSize,h=Math.ceil(f/g),i=[];return i.push(this.loadStorePage(a,c,d,page,h)),Deft.Promise.all(i).then({success:function(a){var c=[];c.push('"'+e.join('","')+'"'),_.each(a,function(a){_.each(a,function(a){c.push(a)})}),c=c.join("\r\n"),b.resolve(c),Rally.getApp().setLoading(!1)}}),b.promise},_getCSVFromCustomBackedGrid:function(a){var b=Ext.create("Deft.Deferred"),c=this;Rally.getApp().setLoading("Assembling data for export...");var d=this._getHeadersFromGrid(a),e=Ext.clone(a.getStore()),f=a.columns,g=(this._getColumnNamesFromGrid(a),a.getStore().getTotalCount()),h=a.getStore().pageSize,i=2e4,j=Math.ceil(g/i);e.pageSize=i;for(var k=[],l=[],m=1;j>=m;m++)k.push(m);return Ext.Array.each(k,function(b){l.push(function(){return c._loadStorePage(a,e,f,b,k.length)})}),Deft.Chain.sequence(l).then({success:function(a){e.pageSize=h,e.loadPage(1);var c=[];c.push('"'+d.join('","')+'"'),_.each(a,function(a){_.each(a,function(a){c.push(a)})}),c=c.join("\r\n"),b.resolve(c),Rally.getApp().setLoading(!1)}}),b.promise},_loadStorePage:function(a,b,c,d,e){var f=Ext.create("Deft.Deferred");return b.loadPage(d,{callback:function(c){for(var d=[],e=0;e<c.length;e++){var g=c[e];d.push(this._getCSVFromRecord(g,a,b))}f.resolve(d)},scope:this}),this.logger.log("_loadStorePage",d," of ",e),f.promise},_getHeadersFromGrid:function(a){var b=[],c=a.columns;return Ext.Array.each(c,function(a){(a.dataIndex||a.renderer)&&(a.csvText?b.push(a.csvText.replace("&nbsp;"," ")):a.text&&b.push(a.text.replace("&nbsp;"," ")))}),b},_getColumnNamesFromGrid:function(a){var b=[],c=a.columns;return Ext.Array.each(c,function(a){(a.dataIndex||a.renderer)&&b.push(a.dataIndex)}),b},getCSVFromGrid:function(a,b){return this.logger.log("Exporting grid with store type:",Ext.getClassName(b.getStore())),"Rally.data.custom.Store"!=Ext.getClassName(b.getStore())?this._getCSVFromWsapiBackedGrid(b):this._getCSVFromCustomBackedGrid(b)},loadStorePage:function(a,b,c,d,e){console.log("Inside loadStorePage");var f=Ext.create("Deft.Deferred");return this.logger.log("loadStorePage",d,e),b.loadPage(d,{callback:function(c,g,h){var i=[];Rally.getApp().setLoading(Ext.String.format("Page {0} of {1} loaded",d,e));for(var j=0;j<c.length;j++){var k=c[j];i.push(this._getCSVFromRecord(k,a,b))}f.resolve(i)},scope:this}),f},_getCSVFromRecord:function(a,b,c){var d={align:"right",classes:[],cellIndex:9,column:null,columnIndex:9,innerCls:void 0,recordIndex:5,rowIndex:5,style:"",tdAttr:"",tdCls:"x-grid-cell x-grid-td x-grid-cell-headerId-gridcolumn-1029 x-grid-cell-last x-unselectable",unselectableAttr:"unselectable='on'"},e=[],f=b.columns;return Ext.Array.each(f,function(f){if("rallyrowactioncolumn"!=f.xtype)if(f.dataIndex){var g=f.dataIndex,h=a.get(g);!f._csvIgnoreRender&&f.renderer&&(h=f.exportRenderer?f.exportRenderer(h,d,a,0,0,c,b.getView()):f.renderer(h,d,a,0,0,c,b.getView())),e.push(h)}else{var h=null;!f._csvIgnoreRender&&f.renderer&&(h=f.exportRenderer?f.exportRenderer(h,d,a,a,0,0,c,b.getView()):f.renderer(h,d,a,a,0,0,c,b.getView()),e.push(h))}},this),'"'+e.join('","')+'"'}}),Ext.define("CArABU.technicalservices.CycleTimeCalculator",{singleton:!0,precision:0,granularity:"day",creationDateText:"(Creation)",noStateText:"(No State)",getTimeInStateData:function(a,b,c,d,e,f){a=_.sortBy(a,d),c===CArABU.technicalservices.CycleTimeCalculator.noStateText&&(c=""),f===CArABU.technicalservices.CycleTimeCalculator.noStateText&&(f="");var g=a[0][b]===c,h=g?Rally.util.DateTime.fromIsoString(a[0][d]):null,i=[],j=0;h&&(i[j]=[h]);var k;return Ext.Array.each(a,function(a){"Accepted"==a.ScheduleState&&(k=Rally.util.DateTime.fromIsoString(a.AcceptedDate));var g=Rally.util.DateTime.fromIsoString(a[d]),h=Rally.util.DateTime.fromIsoString(a._ValidTo);e&&a[e]==f||a[b]===c&&("Accepting"==c&&a.Ready||"Accepted"==a.ScheduleState||"Deployed"==a.ScheduleState||(h=h>new Date?new Date:h,i[j]=[g,h],j++))}),i},getCycleTimeData:function(a,b,c,d,e){var f=[],g=!1;Ext.Array.each(e,function(a){g&&f.push(a==CArABU.technicalservices.CycleTimeCalculator.noStateText?"":a),c==a&&(g=!0,f.push(a==CArABU.technicalservices.CycleTimeCalculator.noStateText?"":a)),d==a&&(g=!1)});var h,i,j,k=0;return Ext.each(a,function(a){null!=a[b]&&Ext.Array.contains(f,a[b])&&("Accepting"==a[b]&&a.Ready||"Accepted"==a.ScheduleState||"Deployed"==a.ScheduleState||(h||(j=Rally.util.DateTime.fromIsoString(a._ValidFrom)),h=Rally.util.DateTime.fromIsoString(a._ValidFrom),i=new Date(a._ValidTo)>new Date?new Date:Rally.util.DateTime.fromIsoString(a._ValidTo),k+=Rally.util.DateTime.getDifference(i,h,"second")))},this),1>k&&(k=null),k&&(k/=CArABU.technicalservices.CycleTimeCalculator.getGranularityMultiplier(CArABU.technicalservices.CycleTimeCalculator.granularity),k=k.toFixed(CArABU.technicalservices.CycleTimeCalculator.precision)),{cycleTime:k,endDate:i,startDate:j}},getGranularityMultiplier:function(a){return a=a.toLowerCase(),"minute"===a?60:"hour"===a?3600:86400},calculateTimeInState:function(a){var b=0;return Ext.Array.each(a,function(a){var c=a.length>0&&a[0]||null,d=a.length>1&&a[1]||new Date;c&&d&&(b+=Rally.util.DateTime.getDifference(d,c,"second"))}),b/=CArABU.technicalservices.CycleTimeCalculator.getGranularityMultiplier(CArABU.technicalservices.CycleTimeCalculator.granularity),b.toFixed(CArABU.technicalservices.CycleTimeCalculator.precision)},getRenderedTimeInStateValue:function(a,b,c,d){var e=a&&a[b];return e&&c&&(e=e[c]),e&&0!==e.length?CArABU.technicalservices.CycleTimeCalculator.calculateTimeInState(e):d},getFirstStartDate:function(a,b,c){var d=a&&a[b];return d&&c&&(d=d[c]),d&&d.length>0?d[0][0]:null},getLastEndDate:function(a,b,c){var d=a&&a[b];return d&&c&&(d=d[c]),d&&d.length>0?d[d.length-1]&&d[d.length-1][0]||null:null},getExportTimestampCSV:function(a,b){for(var c=["FormattedID","State","StateValue","StartDate","EndDate"],d=[c.join(",")],e=function(a,c,d,e){var f=a.length>0&&a[0]&&Rally.util.DateTime.format(a[0],b)||"",g=a.length>1&&a[1]&&Rally.util.DateTime.format(a[1],b)||"",h=[c,d,e,f,g];return h.join(",")},f=0;f<a.length;f++){var g=a[f].get("timeInStateData"),h=a[f].get("FormattedID");g&&Ext.Object.each(g,function(a,b){"snaps"!=a&&(Ext.isArray(b)?Ext.Array.each(b,function(b){d.push(e(b,h,a,"true"))}):Ext.Object.each(b,function(b,c){Ext.Array.each(c,function(c){d.push(e(c,h,a,b))})}))})}return d.join("\r\n")}}),Ext.define("CA.technicalservices.CycleTimePickerButton",{extend:"Rally.ui.Button",alias:"widget.cycletimepickerbutton",hidden:!0,stateful:!0,stateId:"cycleTimePanel",stateEvents:["expand","collapse","parametersupdated"],text:"",dateType:"",config:{context:void 0,modelNames:void 0,toolTipConfig:{anchor:"top",mouseOffset:[-9,-2]}},initComponent:function(){this.callParent(arguments),(!this.stateful||this.stateful&&!this._hasState())&&this.applyState({}),this.on("parametersupdated",this._onPanelChange,this,{buffer:500})},_hasState:function(){return this.stateful&&this.stateId?!!Ext.state.Manager.get(this.stateId):!1},_onPanelChange:function(a){Ext.suspendLayouts(),this.setText(""),this._indicateNoActiveFilterPresent(),Ext.resumeLayouts(!1),this.fireEvent("cycletimeparametersupdated",this)},afterRender:function(){this.callParent(arguments)},hasValidCycleTimeParameters:function(){return this.cycleTimePanel&&this.cycleTimePanel.hasValidCycleTimeParameters()},getCycleTimeParameters:function(){return this.cycleTimePanel&&this.cycleTimePanel.getCycleTimeParameters()},getState:function(){if(this.cycleTimePanel){var a=this.cycleTimePanel.getCycleTimeParameters();return a.collapsed=this.cycleTimePanel.getCollapsed(),a}return Ext.state.Manager.get(this.stateId)},applyState:function(a){this._build(a)},onDestroy:function(){_.invoke(_.compact([this.relayedEvents,this.cycleTimePanel]),"destroy"),this.callParent(arguments)},clearAllFilters:function(){this.cycleTimePanel&&this.cycleTimePanel.clear()},_build:function(a){return this._loadModels().then({success:_.partial(this._onModelLoadSuccess,a),scope:this})},_onModelLoadSuccess:function(a){this._createCycleTimePanel(),a&&this._applyParameters()},_loadModels:function(){return this.models?Deft.Promise.when(this.models):Rally.data.ModelFactory.getModels({context:this.context||Rally.environment.getContext(),types:this.modelNames}).then({success:function(a){this.models=a},scope:this})},_applyParameters:function(a){},_indicateActiveFilterPresent:function(){this.hasCls("primary")||(this.addCls("primary"),this.removeCls("secondary"))},_indicateNoActiveFilterPresent:function(){this.hasCls("secondary")||(this.addCls("secondary"),this.removeCls("primary"))},_createCycleTimePanel:function(){this.cycleTimePanel||(this.cycleTimePanel=Ext.widget({xtype:"cycletimepickerpanel",modelNames:this.modelNames,models:this.models,context:this.context,dateType:this.dateType,flex:1}),this.relayedEvents=this.relayEvents(this.cycleTimePanel,["expand","collapse","panelresize","parametersupdated"]),this.fireEvent("cycletimepickerready",this.cycleTimePanel))},_togglePanel:function(){this.cycleTimePanel&&this.cycleTimePanel.toggleCollapse()},collapse:function(){this.cycleTimePanel&&this.cycleTimePanel.collapse()}}),Ext.define("CArABU.technicalservices.CycleTimeDataStore",{logger:new Rally.technicalservices.Logger,MAX_CHUNK_SIZE:40,USE_POST:!1,constructor:function(a){this.modelNames=a.modelNames,this.stateField=a.stateField,this.includeReady=a.includeReady||!1,this.includeBlocked=a.includeBlocked||!1,this.stateValues=a.stateValues||[],this.fromState=a.fromState,this.toState=a.toState,this.startDate=a.startDate||null,this.endDate=a.endDate||null,this.projects=a.projects||[],this.readyQueueState=a.readyQueueState},load:function(a){var b=Ext.create("Deft.Deferred"),c=_.map(a,function(a){return a.get("ObjectID")});this.logger.log("objectIDs",c);for(var d=[],e=0;e<c.length;e+=this.MAX_CHUNK_SIZE){var f=Ext.Array.slice(c,e,e+this.MAX_CHUNK_SIZE);d.push(this._fetchChunk(f))}return Deft.Promise.all(d).then({success:function(c){this.logger.log("load Success",c);var d=this._getSnapshotsByOid(c),e=this._updateRecords(d,a);b.resolve(e)},failure:function(a){this.logger.log("load Failure",a)},scope:this}),b},_getSnapshotsByOid:function(a){a=_.flatten(a);var b={};return Ext.Array.each(a,function(a){var c=a.get("ObjectID");b[c]||(b[c]=[]),b[c].push(a.getData())}),b},_updateRecords:function(a,b){var c=[];return Ext.Array.each(b,function(b){var d=b.get("ObjectID"),e=a[d],f=this._mungeCycleTimeData(e),g=this._mungeTimeInStateData(e);f&&this._isCycleInDateRange(f,this.startDate,this.endDate)&&(b.set("cycleTimeData",f),b.set("timeInStateData",g),c.push(b))},this),c},_isCycleInDateRange:function(a,b,c){return b&&a.endDate<b?!1:c&&a.endDate>c?!1:!0},_mungeCycleTimeData:function(a){if(!a||0===a.length)return null;var b=CArABU.technicalservices.CycleTimeCalculator.getCycleTimeData(a,this.stateField,this.fromState,this.toState,this.stateValues);return b.snaps=a,b},_mungeTimeInStateData:function(a){if(!a||0===a.length)return null;var b={snaps:a};b.Blocked=CArABU.technicalservices.CycleTimeCalculator.getTimeInStateData(a,"Blocked",!0,"_ValidFrom",this.stateField,this.readyQueueState),b.Ready=CArABU.technicalservices.CycleTimeCalculator.getTimeInStateData(a,"Ready",!0,"_ValidFrom",this.stateField,this.readyQueueState);var c=this.stateField;return b[c]={},Ext.Array.each(this.stateValues,function(d){b[c][d]=CArABU.technicalservices.CycleTimeCalculator.getTimeInStateData(a,c,d,"_ValidFrom")}),b},_fetchChunk:function(a){var b=Ext.create("Deft.Deferred");return this.logger.log("_fetchChunks",a.length),Ext.create("Rally.data.lookback.SnapshotStore",{fetch:this._getFetchList(),filters:[{property:"ObjectID",operator:"in",value:a},{property:"ScheduleState",operator:"<=",value:"Accepted"},{property:"Project",operator:"in",value:this.projects}],useHttpPost:this.USE_POST,sorters:[{property:"ObjectID",direction:"ASC"},{property:"_ValidFrom",direction:"ASC"}],hydrate:this._getHydrateFields(),compress:!0,removeUnauthorizedSnapshots:!0}).load({callback:function(c,d,e){if(e)b.resolve(c);else{var f="Failure loading snapshots for objectIDs: "+a.join(", ")+":  "+d.error.errors.join(",");b.resolve(f)}}}),b},_getFetchList:function(){var a=["FormattedID","AcceptedDate","ScheduleState","_ValidFrom","_ValidTo","ObjectID",this.stateField,"_PreviousValues."+this.stateField];return this.includeReady&&(a=a.concat(["Ready","_PreviousValues.Ready"])),this.includeBlocked&&(a=a.concat(["Blocked","_PreviousValues.Blocked"])),a},_getHydrateFields:function(){var a=["ScheduleState","State"];return Ext.Array.contains(a,this.stateField)?[this.stateField,"_PreviousValues."+this.stateField]:["ScheduleState"]}}),Ext.define("CA.technicalservices.CycleTimePickerPanel",{extend:"Ext.panel.Panel",alias:"widget.cycletimepickerpanel",cls:"inline-filter-panel",flex:1,header:!1,minHeight:46,padding:"8px 0 0 0",bodyPadding:"7px 5px 5px 5px",collapseDirection:"top",collapsible:!0,animCollapse:!1,stateful:!0,stateId:"cycleTimePanel",dateType:"",constructor:function(a){this.mergeConfig(a),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),(!this.stateful||this.stateful&&!this._hasState())&&this.applyState({})},_hasState:function(){return this.stateful&&this.stateId?!!Ext.state.Manager.get(this.stateId):!1},_loadModels:function(a){return this.models?void this._addItems(a):void(this.context&&this.modelNames&&this.modelNames.length>0&&Rally.data.ModelFactory.getModels({types:this.modelNames,context:this.context,success:function(b){this.models=b,this._addItems(a)},scope:this}))},_addItems:function(a){a||(a={}),this.removeAll(),this.add({xtype:"container",flex:1,layout:"hbox",items:[{xtype:"rallyfieldcombobox",model:this.modelNames[0],itemId:"cb-StateField",fieldLabel:"Workflow State",labelAlign:"right",labelWidth:150,width:300,context:this.context,value:a.cycleStateField,_isNotHidden:this._isCycleTimeField}]});var b=[],c=[];a.cycleStates&&a.cycleStates.length>0&&(Ext.Array.each(a.cycleStates,function(d){"ScheduleState"!==a.cycleStateField&&b.push(CArABU.technicalservices.CycleTimeCalculator.noStateText),b.push(d),(!a.cycleEndState||a.cycleEndState===d||c.length>0)&&c.push(d)}),b=_.map(a.cycleStates,function(a){return{value:a}}),c=_.map(a.cycleStates,function(a){return{value:a}})),this.add({xtype:"container",flex:1,layout:"hbox",items:[{xtype:"rallycombobox",itemId:"cb-fromState",allowBlank:!0,allowNoEntry:!0,noEntryText:"-- No State --",fieldLabel:"Workflow State From",labelAlign:"right",labelWidth:150,width:300,store:Ext.create("Rally.data.custom.Store",{data:b}),defaultSelectionPosition:"first",value:a.cycleStartState,valueField:"value",displayField:"value"},{xtype:"rallycombobox",itemId:"cb-toState",fieldLabel:"to",labelWidth:15,labelAlign:"right",width:165,allowBlank:!1,disabled:0===c.length,store:Ext.create("Rally.data.custom.Store",{data:c}),defaultSelectionPosition:"last",value:a.cycleEndState,valueField:"value",displayField:"value",listeners:{scope:this,select:this.updateCycleTimeParameters}}]},{xtype:"rallycombobox",itemId:"cb-rqState",fieldLabel:"Ready Queue Column",labelAlign:"right",labelWidth:150,width:300,allowBlank:!1,disabled:0===c.length,store:Ext.create("Rally.data.custom.Store",{data:c}),defaultSelectionPosition:"first",value:a.cycleReadyQueueState,valueField:"value",displayField:"value",listeners:{scope:this,select:this.updateCycleTimeParameters}}),"LastNMonths"==this.dateType?this.add({xtype:"rallytextfield",fieldLabel:"Last n Months",itemId:"lastNMonths",labelAlign:"right",labelSeparator:"",labelWidth:150,width:200,value:6,toolTipText:"Select the n number of months to calculate the cycle times",listeners:{scope:this,select:this.updateCycleTimeParameters}}):"LastNWeeks"==this.dateType?this.add({xtype:"rallytextfield",fieldLabel:"Last n Weeks",itemId:"lastNWeeks",labelAlign:"right",labelSeparator:"",labelWidth:150,width:200,value:6,toolTipText:"Select the n number of weeks to calculate the cycle times",listeners:{scope:this,select:this.updateCycleTimeParameters}}):this.add({xtype:"container",flex:1,layout:"hbox",items:[{xtype:"rallydatefield",fieldLabel:"Cycle End Date From",labelSeparator:"",itemId:"dtFrom",labelAlign:"right",labelWidth:150,width:300,value:a.startDate||null,toolTipText:"If this is populated, cycle time will only be shown for artifacts that transitioned into the selected Cycle End State AFTER this date.",listeners:{scope:this,select:this.updateCycleTimeParameters}},{xtype:"rallydatefield",fieldLabel:"to",itemId:"dtTo",labelAlign:"right",labelSeparator:"",labelWidth:15,width:165,value:a.endDate||null,toolTipText:"If this is populated, cycle time will only be shown for artifacts that transitioned into the selected Cycle End State BEFORE this date.",listeners:{scope:this,select:this.updateCycleTimeParameters}}]}),this.add({xtype:"rallymultiobjectpicker",modelType:"Project",fieldLabel:"Projects",labelSeparator:"",itemId:"selectedProjects",labelAlign:"right",labelWidth:150,stateful:!0,stateId:"multiObjectPicker1",emptyText:"Search Projects..",width:400,value:a.projects,listeners:{scope:this,select:function(a){a.emptyText=a.selectedValues&&a.selectedValues.length>0?a.selectedValues.length+" Seleted Projects":"Search Projects..",this.updateCycleTimeParameters()},change:function(a){a.emptyText=a.selectedValues&&a.selectedValues.length>0?a.selectedValues.length+" Seleted Projects":"Search Projects.."},deselect:function(a){a.emptyText=a.selectedValues&&a.selectedValues.length>0?a.selectedValues.length+" Seleted Projects":"Search Projects.."},blur:function(a){a.collapse()}}}),this.down("#cb-fromState").on("select",this._updateToState,this);var d=this.down("#cb-StateField");d.on("ready",this._updateStateDropdowns,this),d.on("select",this._updateStateDropdowns,this),this._updateStateDropdowns(d),this.updateCycleTimeParameters()},clear:function(){this._getFromStateCombo().setValue(null)},getState:function(){var a=this.getCycleTimeParameters();return a.cycleStates&&Ext.isArray(a.cycleStates)&&(a.cycleStates=a.cycleStates.join(",")),a},_getStateFieldCombo:function(){return this.down("#cb-StateField")||null},_getFromStateCombo:function(){return this.down("#cb-fromState")||null},_getToStateCombo:function(){return this.down("#cb-toState")||null},_getReadyQueueStateCombo:function(){return this.down("#cb-rqState")||null},applyState:function(a){a&&a.cycleStates&&!Ext.isArray(a.cycleStates)&&(a.cycleStates=a.cycleStates.split(",")),this._loadModels(a)},_updateToState:function(a){var b=this.down("#cb-toState"),c=this.down("#cb-rqState");if(b&&b.setDisabled(!0),c&&c.setDisabled(!0),a&&a.getValue()&&a.getRecord()&&b){var d=[],e=a.getValue();Ext.Array.each(a.getStore().getRange(),function(a){(e===a.get("value")||d.length>0)&&d.push(a.getData())}),b.setDisabled(!1),b.bindStore(Ext.create("Rally.data.custom.Store",{data:d})),c.setDisabled(!1),c.bindStore(Ext.create("Rally.data.custom.Store",{data:d})),this.updateCycleTimeParameters()}},hasValidCycleTimeParameters:function(){var a=this.down("#cb-fromState")&&this.down("#cb-fromState").getValue(),b=this.down("#cb-toState")&&this.down("#cb-toState").getValue();return a&&b?!0:!1},getCycleTimeParameters:function(){var a=this._getStateFieldCombo()&&this._getStateFieldCombo().getValue()||null,b=this._getFromStateCombo()&&this._getFromStateCombo().getValue()||null,c=this._getReadyQueueStateCombo()&&this._getReadyQueueStateCombo().getValue()||null,d=this._getToStateCombo()&&this._getToStateCombo().getValue()||null,e=this.down("#btReady")&&this.down("#btReady").pressed||!1,f=this.down("#btBlocked")&&this.down("#btBlocked").pressed||!1,g=this.down("#cb-fromState")&&this.down("#cb-fromState").getStore().getRange()||[];projects=this.down("#selectedProjects")&&this.down("#selectedProjects").selectedValues.keys||[];var h,i,j=new Date;if("LastNWeeks"==this.dateType){var k=this.down("#lastNWeeks")&&this.down("#lastNWeeks").value||1;i=Ext.Date.clearTime(Ext.Date.subtract(j,Ext.Date.DAY,j.getDay())),h=Ext.Date.clearTime(Ext.Date.subtract(new Date,Ext.Date.DAY,(new Date).getDay()+7*k))}else if("LastNMonths"==this.dateType){var l=this.down("#lastNMonths")&&this.down("#lastNMonths").value||1;i=new Date(j.getFullYear(),j.getMonth(),1),h=Ext.Date.subtract(i,Ext.Date.MONTH,l)}else h=this.down("#dtFrom")&&this.down("#dtFrom").getValue()||null,i=this.down("#dtTo")&&this.down("#dtTo").getValue()||null;return console.log("cycleEndRangeStart,cycleEndRangeTo >>",h,i),g=Ext.Array.map(g,function(a){return a.get("value")}),g=_.uniq(g),{cycleStateField:a,cycleStartState:b,cycleReadyQueueState:c,cycleEndState:d,showReady:e,showBlocked:f,startDate:h,endDate:i,cycleStates:g,projects:projects,lastNMonths:l}},calculateLastNWeeks:function(a){},updateCycleTimeParameters:function(){this.saveState(),this.hasValidCycleTimeParameters()?this.fireEvent("parametersupdated",this.getCycleTimeParameters()):this.fireEvent("parametersupdated",{})},_isCycleTimeField:function(a){var b=["State","ScheduleState"];if(a.hidden)return!1;if(Ext.Array.contains(b,a.name))return!0;if(a.readOnly)return!1;var c=["STATE","STRING"],d=a&&a.attributeDefinition;return d&&d.Constrained&&Ext.Array.contains(c,d.AttributeType)?!0:!1},_toggleButton:function(a,b){b?(a.removeCls("secondary"),a.addCls("primary")):(a.removeCls("primary"),a.addCls("secondary")),this.updateCycleTimeParameters()},_updateStateDropdowns:function(a){var b=this.down("#cb-fromState"),c=this.down("#cb-toState"),d=this.down("#cb-rqState"),e=c&&c.getValue(),f=b&&b.getValue(),g=d&&d.getValue();b&&b.setDisabled(!0),c&&c.setDisabled(!0),d&&d.setDisabled(!0);var h=Ext.create("Rally.data.custom.Store",{data:[]});if(c.bindStore(h),d.bindStore(h),a&&a.getValue()&&a.getRecord()){var i=a.model,j=[];"ScheduleState"!==a.getValue()&&j.push({value:CArABU.technicalservices.CycleTimeCalculator.noStateText}),i.getField(a.getValue()).getAllowedValueStore().load({callback:function(a,h){Ext.Array.each(a,function(a){j.push({value:a.get("StringValue")})});var i=Ext.create("Rally.data.custom.Store",{data:j});b.bindStore(i),b.setDisabled(!1),f?b.setValue(f):b.setValue(j&&j[0].value||null),c.bindStore(i),c.setDisabled(!1),e?c.setValue(e):c.setValue(j&&j.length>0&&j[j.length-1].value||null),d.bindStore(i),d.setDisabled(!1),g?d.setValue(g):d.setValue(j&&j[0].value||null),this.updateCycleTimeParameters()},scope:this})}}}),Ext.define("CArABU.technicalservices.Exporter",{singleton:!0,saveCSVToFile:function(a,b,c){void 0===c&&(c={type:"text/csv;charset=utf-8"}),this.saveAs(a,b,c)},saveAs:function(a,b){if(Ext.isIE9m)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});var c=null;try{c=new Blob([a],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"==d.name&&(bb=new BlobBuilder,bb.append([a]),c=bb.getBlob("text/plain"))}if(!c)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."});var e=b;if(Ext.isIE10p)return void window.navigator.msSaveOrOpenBlob(c,e);var f=this.createObjectURL(c);if(f){var g=document.createElement("a");"download"in g?g.download=e:g.target="_blank",g.innerHTML="Download File",g.href=f,Ext.isChrome||(g.onclick=this.destroyClickedElement,g.style.display="none",document.body.appendChild(g)),g.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(a){return window.webkitURL?window.webkitURL.createObjectURL(a):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null},destroyClickedElement:function(a){document.body.removeChild(a.target)}}),Ext.define("CA.technicalservices.FieldPicker",{alias:"widget.fieldpickerbutton",extend:"Rally.ui.Button",requires:["Rally.ui.popover.Popover","Rally.ui.Button","Rally.ui.picker.FieldPicker","Ext.state.Manager"],toolTipConfig:{html:"Show Columns",anchor:"top"},iconCls:"icon-add-column",cls:"field-picker-btn secondary rly-small",alwaysSelectedValues:["FormattedID","Name"],fieldBlackList:[],fieldPickerConfig:{},buttonConfig:{},modelNames:[],rankingEnabled:!1,margin:"3 9 0 0",constructor:function(a){this.config=_.merge({},this.config||{},a||{}),this.callParent([a])},initComponent:function(){if(this.models)return this.on("click",this._createPopover,this),void this.callParent(arguments);if(this.context&&this.modelNames&&this.modelNames.length>0)Rally.data.ModelFactory.getModels({types:this.modelNames,context:this.context,success:function(a){console.log("models"),this.models=a},failure:function(a){console.log("failedparam")},scope:this}),this.on("click",this._createPopover,this);else{this.iconCls="icon-none";var a="Please update the CA.technicalservices.FieldPicker configuration with modelNames and context";
this.toolTipConfig={html:'<div style="color:red;">'+a+"</div>"},this.on("click",function(){Rally.ui.notify.Notifier.showError({message:a})})}this.callParent(arguments)},getFields:function(){return this._fields||this.alwaysSelectedValues},_getPickerConfig:function(){var a;return a=_.extend({value:this._fields,fieldBlackList:this.fieldBlackList,alwaysSelectedValues:this.alwaysSelectedValues,context:this.context},this.fieldPickerConfig)},_createPopover:function(a){var b=a.getEl();this.popover=Ext.create("Rally.ui.popover.Popover",{target:b,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:this.getTitle(),listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Apply",cls:"field-picker-apply-btn primary rly-small",listeners:{click:function(){this._onApply(this.popover)},scope:this}},{xtype:"rallybutton",text:"Cancel",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[_.extend({xtype:"rallyfieldpicker",cls:"field-picker",itemId:"fieldpicker",modelTypes:this._getModelTypes(),alwaysExpanded:!0,width:200,emptyText:"Search",selectedTextLabel:"Selected",availableTextLabel:"Available",listeners:{specialkey:function(a,b){b.getKey()===b.ESC&&this.popover.close()},scope:this}},this._getPickerConfig())]})},_getModelTypes:function(){return _.pluck(this._getModels(),"typePath")},_getModels:function(){return _.reduce(this.models,function(a,b){return"artifact"===b.typePath?a=a.concat(b.getArtifactComponentModels()):a.push(b),a},[])},getTitle:function(){return"Show Columns"},updateFields:function(a,b){this._fields=a,this.popover&&this.popover.down("rallyfieldpicker")&&this.popover.down("rallyfieldpicker").setValue(a.join(",")),this.saveState()},getState:function(){return{fields:this._fields}},applyState:function(a){a&&(this._fields=a.fields)},_onApply:function(a){var b=a.down("rallyfieldpicker"),c=_.map(b.getValue(),function(a){return a.get("name")});this.updateFields(c),a.close(),this.fireEvent("fieldsupdated",c)}}),Ext.define("Rally.ui.LeftRight",{alias:"widget.rallyleftright",extend:"Ext.container.Container",cls:"rui-leftright",defaults:{xtype:"container"},items:[{itemId:"left",cls:"rly-left"},{itemId:"right",cls:"rly-right"}],getLeft:function(){return this.down("#left")},getRight:function(){return this.down("#right")}}),Ext.apply(Ext.data.SortTypes,{asUser:function(a){return Ext.isString(a)?a:a&&a.DisplayName||a._refObjectName}}),Ext.override(Rally.ui.grid.TreeGrid,{_mergeColumnConfigs:function(a,b){var c=_.map(a,function(a){var c=_.find(b,{dataIndex:this._getColumnName(a)});return c?this._getColumnConfigFromColumn(c):a},this);return c=c.concat(this.config.derivedColumns)},_getColumnConfigsBasedOnCurrentOrder:function(a){var b=_(this.headerCt.items.getRange()).map(function(b){return _.contains(a,b.dataIndex)?b.dataIndex:_.find(a,{xtype:b.xtype,text:b.text})}).compact().value();return b},_restoreColumnOrder:function(a){var b=this._getColumnConfigsBasedOnCurrentOrder(a),c=_.filter(a,function(a){return Ext.isString(a)?!0:_.find(b,{dataIndex:a.dataIndex})&&_.find(b,{text:a.text})?!1:!0});return console.log("added columns",c,a,b),b.concat(c)},_applyStatefulColumns:function(a){this.alwaysShowDefaultColumns&&_.each(this.columnCfgs,function(b){_.any(a,{dataIndex:this._getColumnName(b)})||a.push(b)},this),this.config&&this.config.derivedColumns?this.columnCfgs=a.concat(this.config.derivedColumns):this.columnCfgs=a}}),Ext.define("CArABU.technicalservices.CycleTimeData.Settings",{singleton:!0,getFields:function(a){current_date_type=a&&a.dateType||"DateRange",console.log("settings>>",a);var b=Ext.create("Ext.data.Store",{fields:["name"],data:[{name:"User Story & Defect"},{name:"Feature"}]});return[{xtype:"combobox",name:"artifactType",store:b,fieldLabel:"Artifact Type",queryMode:"local",allowBlank:!1,labelAlign:"right",labelWidth:100,valueField:"name",displayField:"name",value:a.artifactType},{xtype:"rallynumberfield",fieldLabel:"Max Export Limit",name:"exportLimit",labelAlign:"right",labelWidth:100,minValue:10,maxValue:1e4,value:a.exportLimit},{xtype:"radiogroup",fieldLabel:"Date Type",columns:1,vertical:!0,labelAlign:"top",layout:"hbox",labelWidth:100,labelCls:"settingsLabel",items:[{boxLabel:"Date Range",name:"dateType",inputValue:"DateRange",checked:"DateRange"===current_date_type},{boxLabel:"Last N Weeks",name:"dateType",inputValue:"LastNWeeks",checked:"LastNWeeks"===current_date_type},{boxLabel:"Last N Months",name:"dateType",inputValue:"LastNMonths",checked:"LastNMonths"===current_date_type}]},{xtype:"radiogroup",fieldLabel:"Granularity",columns:1,vertical:!0,labelAlign:"top",layout:"hbox",labelWidth:100,width:300,labelCls:"settingsLabel",items:[{boxLabel:"Day",name:"granularity",inputValue:"day",checked:"day"===a.granularity},{boxLabel:"Minute",name:"granularity",inputValue:"minute",checked:"minute"===a.granularity}]},{xtype:"radiogroup",fieldLabel:"Chart Type",columns:1,vertical:!0,labelAlign:"top",layout:"hbox",labelWidth:100,width:300,labelCls:"settingsLabel",items:[{boxLabel:"Bar",name:"chartType",inputValue:"column",checked:"column"===a.chartType},{boxLabel:"Line",name:"chartType",inputValue:"line",checked:"line"===a.chartType}]},{xtype:"textarea",fieldLabel:"Query",name:"queryFilter",anchor:"100%",cls:"query-field",margin:"0 70 0 0",labelAlign:"right",labelWidth:100,plugins:[{ptype:"rallyhelpfield",helpId:194},"rallyfieldvalidationui"],validateOnBlur:!1,validateOnChange:!1,validator:function(a){try{return a&&Rally.data.wsapi.Filter.fromQueryString(a),!0}catch(b){return b.message}}}]}}),Ext.define("CArABU.technicalservices.CycleTimeTemplateColumn",{extend:"Ext.grid.column.Template",alias:["widget.cycletimetemplatecolumn"],align:"right",initComponent:function(){var a=this;Ext.QuickTips.init(),a.tpl=new Ext.XTemplate('<tpl><div data-qtip="{[this.getTooltip(values)]}" style="cursor:pointer;text-align:right;">{[this.getCycleTime(values)]}</div></tpl>',{getCycleTime:function(a){var b=a&&a.cycleTime;return b>=0?b:"--"},getTooltip:function(a){var b="";return a&&a.startDate&&(b=Ext.String.format("Start: {0}",Rally.util.DateTime.format(a.startDate,"Y-m-d h:i:s a"))),a&&a.cycleTime&&a.endDate&&(b=Ext.String.format("{0} days<br/>{1}</br>End: {2}",a.cycleTime,b,Rally.util.DateTime.format(a.endDate,"Y-m-d h:i:s a"))),b}}),a.hasCustomRenderer=!0,a.callParent(arguments)},defaultRenderer:function(a,b,c){var d=Ext.apply({},c.get("cycleTimeData"));return this.tpl.apply(d)}}),Ext.define("CArABU.technicalservices.TimeTemplateColumn",{extend:"Ext.grid.column.Template",alias:["widget.timetemplatecolumn"],align:"right",initComponent:function(){var a=this;Ext.QuickTips.init(),a.tpl=new Ext.XTemplate('<tpl><div data-qtip="{[this.getTooltip(values)]}" style="cursor:pointer;text-align:right;">{[this.getCurrentIcon(values)]}{[this.getTime(values)]}</div></tpl>',{stateName:a.stateName,dataType:a.dataType,stateValue:a.stateValue,getTime:function(a){return CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(a,this.stateName,this.stateValue,"--")},getCurrentIcon:function(a){if(a.currentValue&&(a.currentValue===!0||a.currentValue===this.stateValue)){var b="icon-square",c="#005eb8";return"Blocked"===this.stateName&&(b="icon-blocked",c="#b81b10"),"Ready"===this.stateName&&(b="icon-ready",c="#8dc63f"),Ext.String.format('<div class="{0}" style="color:{1}"></div>',b,c)}return""},getTooltip:function(a){var b=a[this.stateName];if(b&&this.stateValue&&(b=b[this.stateValue]),!b||0===b.length)return"";var c=this.stateValue||"[No State]";("Blocked"===this.stateName||"Ready"===this.stateName)&&(c="true");var d=Ext.String.format("{0}: {1}<br/>",this.stateName,c);return Ext.Array.each(b,function(a){var b=a&&a.length>0&&Rally.util.DateTime.format(a[0],"Y-m-d h:i:s a")||"",c=a&&a.length>1&&Rally.util.DateTime.format(a[1],"Y-m-d h:i:s a")||"current";b.length>0&&(d+=Ext.String.format("{0} - {1}<br/>",b,c))}),d}}),a.hasCustomRenderer=!0,a.callParent(arguments)},defaultRenderer:function(a,b,c){var d=Ext.apply({},c.get(this.dataType));return d.currentValue=c.get(this.stateName),this.tpl.apply(d)}}),Ext.define("CA.technicalservices.Utility",{singleton:!0,loadModels:function(a,b){return Rally.data.ModelFactory.getModels({types:a,context:b})}}),Ext.define("cycle-time-summary-app",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10,labelAlign:"right"},instructions:"Please select the criteria for report and click update to see the report",items:[{xtype:"container",itemId:"selector_box_parent",layout:"hbox",items:[{xtype:"container",itemId:"selector_box",layout:"hbox",flex:1},{xtype:"container",itemId:"selector_box_right",layout:"hbox",cls:"rly-right"}]},{xtype:"container",itemId:"filter_box",flex:1},{xtype:"container",itemId:"cycletime_box",flex:1},{xtype:"container",itemId:"message_box",flex:1,height:45,tpl:'<tpl><div class="no-data-container"><div class="secondary-message">{message}</div></div></tpl>'},{xtype:"container",itemId:"grid_box"}],integrationHeaders:{name:"cycle-time-summary-app"},config:{defaultSettings:{artifactType:"User Story & Defect",queryFilter:"",granularity:"minute",precision:2,exportLimit:1e4}},exportDateFormat:"m/d/Y h:i:s",_gridConfig:{},launch:function(){this.logger.log("Launch Settings",this.getSettings()),this.addSelectors()},showErrorNotification:function(a){a||(a="Error during execution.  See logs for details."),Rally.ui.notify.Notifier.showError({message:a})},addSelectors:function(){this.getSelectorBox().removeAll(),this.getCycleTimeBox().removeAll(),this.getFilterBox().removeAll(),this.getMessageBox().update({message:this.instructions});this.getSelectorBox().add({xtype:"cycletimepickerbutton",modelNames:this.getModelNames(),context:this.getContext(),dateType:this.getSetting("dateType"),margin:"3 9 0 0",listeners:{cycletimepickerready:this.addCycleTimePanel,scope:this,cycletimeparametersupdated:this.updateCycleTimeParameters}});this.getSelectorBoxRight().removeAll();var a=this.getSelectorBoxRight().add({xtype:"rallybutton",itemId:"btUpdate",text:"Update",width:100,margin:"3 9 0 0"});a.on("click",this.updateGrid,this),this.getSelectorBoxRight().add({xtype:"rallybutton",style:{"float":"right"},cls:"secondary rly-small",margin:"3 9 0 0",frame:!1,itemId:"actions-menu-button",iconCls:"icon-export",listeners:{click:this._export,scope:this}})},showInstructionsDialog:function(a){var b=a.getEl();this.popover=Ext.create("Rally.ui.popover.Popover",{target:b,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:"Cycle Time App Instructions",width:Math.min(this.getWidth(),400),listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Close",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[{xtype:"container",html:this.instructions}]})},showExportMenu:function(a){var b=Ext.widget({xtype:"rallymenu",items:[{text:"Export Summary...",handler:function(){this.exportData(!1,!0)},scope:this},{text:"Export with Timestamps...",handler:function(){this.exportData(!0,!1)},scope:this},{text:"Export Summary and Timestamps...",handler:function(){this.exportData(!0,!0)},scope:this}]});b.showBy(a.getEl()),a.toolTip&&a.toolTip.hide()},getSelectorBoxRight:function(){return this.down("#selector_box_right")},getFilterBox:function(){return this.down("#filter_box")},getCycleTimeBox:function(){return this.down("#cycletime_box")},addInlineFilterPanel:function(a){this.logger.log("addInlineFilterPanel",a),this.getFilterBox().add(a)},addCycleTimePanel:function(a){this.logger.log("addCycleTimePanel",a),this.getCycleTimeBox().add(a)},updateGridFields:function(a){this.logger.log("updateGridFields",a),this._gridConfig.fields=a,this.updateGrid()},setUpdateButtonUpdateable:function(a){var b=this.down("#btUpdate");b&&(a?(b.setDisabled(!1),b.setIconCls("icon-refresh")):(b.setDisabled(!0),b.setIconCls("")))},updateGridFilters:function(a){this.logger.log("updateGridFilters",a.getTypesAndFilters()),this._gridConfig.filters=a.getTypesAndFilters(),this.getSelectorBox().doLayout(),this.setUpdateButtonUpdateable(!0)},updateCycleTimeParameters:function(a){this.logger.log("updateCycleTimeParameters",a.getCycleTimeParameters()),this._gridConfig.cycleTimeParameters=a.getCycleTimeParameters(),this.setUpdateButtonUpdateable(!0)},calculateCycleTime:function(){return this.down("cycletimepickerbutton")&&this.down("cycletimepickerbutton").hasValidCycleTimeParameters()||!1},getMessageBox:function(){return this.down("#message_box")},updateMessageBox:function(a,b){b&&(a=Ext.String.format('<span style="color:{0};">{1}</span>',b,a)),this.getMessageBox().update({message:a})},updateGrid:function(){return 0==this.getSelectedProjects().length?void this.updateMessageBox("No project selected select one or more projects to display the Summary"):(CArABU.technicalservices.CycleTimeCalculator.startDate=this.getStartDate(),CArABU.technicalservices.CycleTimeCalculator.endDate=this.getEndDate(),CArABU.technicalservices.CycleTimeCalculator.precision=this.getSetting("precision"),CArABU.technicalservices.CycleTimeCalculator.granularity=this.getSetting("granularity"),this.getGridBox().removeAll(),this.updateMessageBox(),this.setLoading("Loading Current Data..."),void this.fetchWsapiArtifactData().then({success:this.buildCycleGrid,failure:this.showErrorNotification,scope:this}).always(function(){this.setLoading(!1)},this))},buildCycleGrid:function(a){this.logger.log("buildCycleGrid",a),a&&a.length>0&&(this.calculateCycleTime()?(this.setLoading("Loading Historical data..."),this.fetchHistoricalData(a).then({success:this.calculateSummary,failure:this.showErrorNotification,scope:this}).always(function(){this.setLoading(!1)},this)):this.addGrid(a))},calculateSummary:function(a){var b=this;this.logger.log("calculateSummary",a,a.length);var c={},d=[],e=b.getCycleStates(),f=b.getReqdyQueueStateValue();if("LastNWeeks"==b.getSetting("dateType")){console.log(b.getStartDate(),b.getEndDate());var g=Rally.util.DateTime.getDifference(b.getEndDate(),b.getStartDate(),"day")/7,h=b.getStartDate();for(i=0;i<g;i++)c[Ext.Date.format(h,"d-M-y")]={Week:Ext.Date.format(h,"d-M-y"),StartDate:h,EndDate:Ext.Date.add(h,Ext.Date.DAY,7),LeadTime:0,ReadyQueueTime:0,BlockTime:0,ReadyTime:0,TotalArtifacts:0,Records:[]},h=Ext.Date.add(h,Ext.Date.DAY,7);Ext.Object.each(c,function(d,g){Ext.Array.each(a,function(a){if(a.get("AcceptedDate")&&Ext.Date.between(a.get("AcceptedDate"),g.StartDate,g.EndDate)){var h=CArABU.technicalservices.CycleTimeCalculator.getCycleTimeData(a.get("cycleTimeData").snaps,b.getStateField(),b.getReqdyQueueStateValue(),f,e);c[d].LeadTime+=Ext.Number.from(a.get("cycleTimeData").cycleTime,0),c[d].ReadyQueueTime+=Ext.Number.from(h.cycleTime,0),c[d].BlockTime+=Ext.Number.from(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(a.get("timeInStateData"),"Blocked",null,""),0),c[d].ReadyTime+=Ext.Number.from(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(a.get("timeInStateData"),"Ready",null,""),0),c[d].TotalArtifacts++,c[d].Records.push(a)}})}),console.log(c)}else Ext.Array.each(a,function(a){var d=CArABU.technicalservices.CycleTimeCalculator.getCycleTimeData(a.get("cycleTimeData").snaps,b.getStateField(),b.getReqdyQueueStateValue(),f,e);c[a.get("Project").ObjectID]?(c[a.get("Project").ObjectID].LeadTime+=Ext.Number.from(a.get("cycleTimeData").cycleTime,0),c[a.get("Project").ObjectID].ReadyQueueTime+=Ext.Number.from(d.cycleTime,0),c[a.get("Project").ObjectID].BlockTime+=Ext.Number.from(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(a.get("timeInStateData"),"Blocked",null,""),0),c[a.get("Project").ObjectID].ReadyTime+=Ext.Number.from(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(a.get("timeInStateData"),"Ready",null,""),0),c[a.get("Project").ObjectID].TotalArtifacts++,c[a.get("Project").ObjectID].Records.push(a)):c[a.get("Project").ObjectID]={Project:a.get("Project").Name,LeadTime:Ext.Number.from(a.get("cycleTimeData").cycleTime,0),ReadyQueueTime:Ext.Number.from(d.cycleTime,0),BlockTime:Ext.Number.from(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(a.get("timeInStateData"),"Blocked",null,""),0),ReadyTime:Ext.Number.from(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(a.get("timeInStateData"),"Ready",null,""),0),TotalArtifacts:1,Records:[a]}});this.logger.log("cycle_time_summary>>",c),Ext.Object.each(c,function(a,b){b.AvgLeadTime=b.LeadTime/b.TotalArtifacts,b.AvgBlockTime=b.BlockTime/b.TotalArtifacts,b.AvgReadyTime=b.ReadyTime/b.TotalArtifacts,b.AvgReadyQueueTime=b.ReadyQueueTime/b.TotalArtifacts,b.AvgCycleTime=b.AvgLeadTime-b.AvgReadyQueueTime,b.AvgActiveCycleTime=b.AvgLeadTime-b.AvgReadyQueueTime-b.AvgBlockTime-b.AvgReadyTime,d.push(b)});var j=Ext.create("Rally.data.custom.Store",{data:d});b.overallSummaryData={},"LastNWeeks"==b.getSetting("dateType")?b.overallSummaryData.Week="Total":b.overallSummaryData.Project="Total",b.overallSummaryData.AvgLeadTime=j.average("AvgLeadTime"),b.overallSummaryData.AvgCycleTime=j.average("AvgCycleTime"),b.addSummaryGrid(j),b.results=d},addChart:function(a){var b=this.getSetting("chartType");"line"==b&&a.splice(a.length-1,1),this.getGridBox().add({xtype:"rallychart",loadMask:!1,chartData:this.getChartData(a),chartConfig:this.getChartConfig(b)})},getChartData:function(a){console.log("results>>",a);var b=this,c=[],d=[],e=[];return Ext.Array.each(a,function(a){c.push("LastNWeeks"==b.getSetting("dateType")?a.Week:a.Project),d.push(Ext.util.Format.round(a.AvgLeadTime,2)),e.push(Ext.util.Format.round(a.AvgCycleTime,2))}),{series:[{name:"Lead",data:d,pointPadding:.3,color:"Orange"},{name:"Cycle",data:e,pointPadding:.4,color:"Green"}],categories:c}},getChartConfig:function(a){var b=this;return{chart:{type:a},title:{text:"Cycle Time Summary"},xAxis:{},yAxis:{min:0,title:{text:b.getSetting("granularity")}},plotOptions:{column:{dataLabels:{enabled:!0},grouping:!1,shadow:!1,borderWidth:0}}}},addSummaryGrid:function(a){var b=this;this.suspendLayouts(),this.getGridBox().add({xtype:"rallygrid",store:a,columnCfgs:this.getSummaryColumnCfgs(),showPagingToolbar:!0,scroll:"vertical",title:"Cycle Time Summary in ("+b.getSetting("granularity")+")",titleAlign:"center",bodyPadding:10,showRowActionsColumn:!1,features:[{ftype:"summary"}],viewConfig:{listeners:{refresh:function(a){console.log(a),console.log("is fully loaded",a),b.results.push({Project:"Total",AvgLeadTime:a.summaryFeature.summaryRecord.data.AvgLeadTime,AvgCycleTime:a.summaryFeature.summaryRecord.data.AvgCycleTime}),b.addChart(b.results)},cellclick:b.showDrillDown,scope:b}},ptyText:'<div class="no-data-container"><div class="secondary-message">No data was found for the selected current filters, cycle time parameters and projects selected.</div></div>'}),this.resumeLayouts(!0)},showDrillDown:function(a,b,c,d){console.log(a,b,c,d);var e=Ext.create("Rally.data.custom.Store",{data:d.get("Records"),pageSize:2e3});Ext.create("Rally.ui.dialog.Dialog",{id:"detailPopup",title:"Records for "+d.get("Project"),width:Ext.getBody().getWidth()-50,height:Ext.getBody().getHeight()-50,closable:!0,layout:"border",items:[{xtype:"rallygrid",region:"center",layout:"fit",sortableColumns:!0,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:this.getDrillDownColumns(),store:e}]}).show()},getDrillDownColumns:function(){return[{dataIndex:"FormattedID",text:"id"},{dataIndex:"Name",text:"Name",flex:1},{dataIndex:"ScheduleState",text:"Schedule State"}].concat(this.getHistoricalDataColumns())},_export:function(){var a=this;if(a.results){var b=Ext.String.format("summary_export.csv");a._create_csv(a.results),Rally.technicalservices.FileUtilities.saveCSVToFile(a.CSV,b)}},_create_csv:function(a){var b=this;if(a){b.setLoading("Generating CSV");var c="",d="",e=b.getSummaryColumnCfgs(),f=[];Ext.Array.each(e,function(a){d+=a.text.replace("<BR>","")+",",f.push(a.dataIndex)}),c+=d+"\r\n",d="",c+=d+"\r\n",Ext.Array.each(b.results,function(a){d="",Ext.Array.each(f,function(b){d+=a[b]?a[b]+",":","},b),c+=d+"\r\n",a.children&&a.children.length>0&&Ext.Array.each(a.children,function(a){d="",Ext.Array.each(f,function(b){d+=a[b]?a[b]+",":","},b),c+=d+"\r\n",a.children&&a.children.length>0&&Ext.Array.each(a.children,function(a){d="",Ext.Array.each(f,function(b){d+="Name"==b||"WorkProduct"==b?a[b]?'"'+a[b].replace(/"/g,'""')+'",':",":a[b]?a[b]+",":","},b),c+=d+"\r\n"})},b)},b),b.CSV=c,b.setLoading(!1)}},fetchWsapiArtifactData:function(){var a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.artifact.Store",{models:this.getModelNames(),limit:this.getExportLimit(),fetch:this.getCurrentFetchList(),filters:this.getWsapiArtifactFilters(),context:{projectScopeUp:!1,projectScopeDown:!1,project:null},pageSize:Math.min(this.getExportLimit(),1e3)}).load({callback:function(b,c){if(this.logger.log("fetchWsapiArtifactData",b.length,c,b),c.wasSuccessful()){var d=c&&c.resultSet&&c.resultSet.total;this.logger.log("count",d,this.getExportLimit()),d>this.getExportLimit()?a.resolve(null):a.resolve(b)}else a.reject("Unable to get artifact count:  "+c.error.errors.join(","))},scope:this}),a},getWsapiArtifactFilters:function(){var a=this._gridConfig&&this._gridConfig.filters&&this._gridConfig.filters.filters[0]||null;if(this.getQueryFilter()&&(a=a?a.and(this.getQueryFilter()):this.getQueryFilter()),this.logger.log("getWsapiArtifactFilters",a),this.calculateCycleTime()&&this.getShowOnlyCompletedCycles()){var b=this.getCycleStates(),c=[],d=this.getStateField(),e=this.getToStateValue(),f=new RegExp("PortfolioItem/","i");f.test(this.getModelNames()[0])&&"State"===d&&(d="State.Name"),Ext.Array.each(b,function(a){(a===e||c.length>0)&&c.push({property:d,value:a})}),c=Rally.data.wsapi.Filter.or(c),a=a?a.and(c):c}var g=[];Ext.Array.each(this.getSelectedProjects(),function(a){g.push({property:"Project",value:a})}),a.and(Rally.data.wsapi.Filter.or(g));var h=a.and(Rally.data.wsapi.Filter.or(g));return a=h||[],this.logger.log("getWsapiArtifactFilters",a.toString()),a},getStartDate:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.startDate?this._gridConfig.cycleTimeParameters.startDate:null},getEndDate:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.endDate?this._gridConfig.cycleTimeParameters.endDate:null},getCycleStates:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleStates||[]},getGridColumns:function(){return this.down("fieldpickerbutton")&&this.down("fieldpickerbutton").getFields()},getPreviousStates:function(a){for(var b=this.getCycleStates(),c=[null],d=0;d<b.length;d++){var e=b[d];e===a?d=b.length:e&&e.length>0&&c.push(e)}return this.logger.log("getPreviousStates",c),c},getEndStates:function(a){a||(a=this.getToStateValue());var b=this.getCycleStates(),c=[];this.logger.log("getEndStates",a,b);for(var d=b.length-1;d>0;d--){var e=b[d];c.push(e),e===a&&(d=0)}return c},getCurrentFetchList:function(){var a=["ObjectID","Project","Blocked","Ready","Name","FormattedID","ScheduleState","AcceptedDate"];return this.getStateField()&&Ext.Array.merge(this.getStateField(),a),a},getShowOnlyCompletedCycles:function(){return!0},getWsapiArtifactCount:function(a){a.limit=1,a.fetch=["ObjectID"],a.pageSize=1;var b=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.artifact.Store",a).load({callback:function(a,c){if(this.logger.log("getWsapiArtifactCount",c),c.wasSuccessful()){var d=c&&c.resultSet&&c.resultSet.total;b.resolve(d)}else b.reject("Unable to get aritfact count:  "+c.error.errors.join(","))},scope:this}),b},getExportLimit:function(){return this.getSetting("exportLimit")||1e3},getStateValueArray:function(){var a=_.map(this.getFromStateCombo().getStore().getRange(),function(a){return a.get("value")},this);return Ext.Array.remove(a,""),a},fetchHistoricalData:function(a){var b=Ext.create("Deft.Deferred");if(this.logger.log("fetchHistoricalData",a),this.calculateCycleTime()&&a.length>0){this.setLoading(Ext.String.format("Loading historical data for {0} artifacts.",a.length));var c=this.getIncludeBlocked(),d=this.getIncludeReady(),e=this.getFromStateValue(),f=this.getToStateValue(),g=this.getStateField(),h=this.getCycleStates(),i=this.getReqdyQueueStateValue();this.logger.log("stateValues",h),Ext.create("CArABU.technicalservices.CycleTimeDataStore",{stateField:g,stateValues:h,includeReady:d,includeBlocked:c,fromState:e,toState:f,startDate:this.getStartDate(),endDate:this.getEndDate(),projects:this.getSelectedProjectOids(),readyQueueState:i}).load(a).then({success:function(a){b.resolve(a)},failure:function(a){b.reject(a)},scope:this}).always(function(){this.setLoading(!1)},this)}else b.resolve(a);return b},updateHistoricalData:function(a){this.logger.log("updateHistoricalData",a)},getCycleTimeColumnHeader:function(){return Ext.String.format("Cycle time from {0} to {1} ({2}s)",this.getFromStateValue(),this.getToStateValue(),CArABU.technicalservices.CycleTimeCalculator.granularity)},getCycleTimeStartColumnHeader:function(){return"Cycle Time Start Date"},getCycleTimeEndColumnHeader:function(){return"Cycle Time End Date"},getTimeInStateColumnHeader:function(a){return Ext.String.format("Time in {0} ({1}s)",a||"[No State]",CArABU.technicalservices.CycleTimeCalculator.granularity)},getHistoricalDataColumns:function(){var a=[],b=this.getToStateValue(),c=this.getFromStateValue();return c&&b&&a.push({xtype:"cycletimetemplatecolumn",text:this.getCycleTimeColumnHeader(),flex:1}),this.getIncludeBlocked()&&a.push({xtype:"timetemplatecolumn",dataType:"timeInStateData",stateName:"Blocked",text:this.getTimeInStateColumnHeader("Blocked"),flex:1}),this.getIncludeReady()&&a.push({xtype:"timetemplatecolumn",dataType:"timeInStateData",stateName:"Ready",text:this.getTimeInStateColumnHeader("Ready"),flex:1}),c&&b&&Ext.Array.each(this.getCycleStates(),function(c){if(c&&c.length>0){var d=this.getTimeInStateColumnHeader(c);if(a.push({xtype:"timetemplatecolumn",dataType:"timeInStateData",stateName:this.getStateField(),stateValue:c,text:d,flex:1}),c===b)return!1}},this),this.logger.log("getHistoricalDataColumns",a),a},getColumnCfgs:function(a){var b=[];return Ext.Array.each(this.getCurrentFetchList(),function(c){if("ObjectID"!==c){if(a)var d=a.getField(c),e=Rally.ui.renderer.RendererFactory.getRenderTemplate(d),f={text:d.displayName,dataIndex:c,renderer:function(a,b,c){return e.apply(c.getData())}};else var f={text:c.replace("c_",""),dataIndex:c};"Name"===c&&(f.flex=1),b.push(f)}}),this.calculateCycleTime()&&(b=b.concat(this.getHistoricalDataColumns())),this.logger.log("getColumnCfgs",b),b},getSummaryColumnCfgs:function(){var a=this;a.overallSummaryData={Project:"Total"};var b=[{dataIndex:"LastNWeeks"==a.getSetting("dateType")?"Week":"Project",text:"LastNWeeks"==a.getSetting("dateType")?"Week":"Project",summaryRenderer:function(){return"Total"},flex:1},{dataIndex:"AvgLeadTime",text:"Avg. Lead Time",summaryType:"average",renderer:function(a){return Ext.Number.toFixed(a,2)},exportRenderer:function(a){return a},summaryRenderer:function(b,c,d){return a.overallSummaryData.AvgLeadTime=b,Ext.Number.toFixed(b,2)}},{dataIndex:"AvgReadyQueueTime",text:"Avg. Ready Queue Time",summaryType:"average",renderer:function(a){return Ext.Number.toFixed(a,2)},exportRenderer:function(a){return a},summaryRenderer:function(a,b,c){return Ext.Number.toFixed(a,2)}},{dataIndex:"AvgCycleTime",text:"Avg. Cycle Time",summaryType:"average",renderer:function(a){return Ext.Number.toFixed(a,2)},exportRenderer:function(a){return a},summaryRenderer:function(b,c,d){return a.overallSummaryData.AvgCycleTime=b,Ext.Number.toFixed(b,2)}},{dataIndex:"AvgActiveCycleTime",text:"Avg. Active Cycle Time",summaryType:"average",renderer:function(a){return Ext.Number.toFixed(a,2)},exportRenderer:function(a){return a},summaryRenderer:function(a,b,c){return Ext.Number.toFixed(a,2)}},{dataIndex:"AvgBlockTime",text:"Avg. Block Time",summaryType:"average",renderer:function(a){return Ext.Number.toFixed(a,2)},exportRenderer:function(a){return a},summaryRenderer:function(a,b,c){return Ext.Number.toFixed(a,2)}},{dataIndex:"AvgReadyTime",text:"Avg. Ready to Pull Time",summaryType:"average",renderer:function(a){return Ext.Number.toFixed(a,2)},exportRenderer:function(a){return a},summaryRenderer:function(a,b,c){return Ext.Number.toFixed(a,2)}}];return b},exportData:function(a,b){var c=this.down("rallygrid");if(!c)return void this.showErrorNotification("Cannot save export becuase there is no data displapyed to export.");var d=c.getStore().getTotalCount();this.logger.log("exportData",d);var e=c.getStore();this.getMessageBox().setLoading("Preparing Export File(s)..."),e.load({pageSize:d,limit:d,callback:function(c,d){if(this.getMessageBox().setLoading(!1),d.wasSuccessful()){var e=this.getColumnCfgs(c&&c[0]);this.saveExportFiles(c,e,a,b)}else this.logger.log("Error preparing export data",d),Rally.ui.notify.Notifier.showError("Error preparing export data:  "+d&&d.error&&d.error.errors.join(","))},scope:this})},saveExportFiles:function(a,b,c,d){if(d){var e=Ext.String.format("cycle-time-{0}.csv",Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s")),f=this.getExportSummaryCSV(a,b);CArABU.technicalservices.Exporter.saveCSVToFile(f,e)}if(c){var e=Ext.String.format("time-in-state-{0}.csv",Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s")),g=this.getExportTimestampCSV(a);CArABU.technicalservices.Exporter.saveCSVToFile(g,e)}},getExportTimestampCSV:function(a){return CArABU.technicalservices.CycleTimeCalculator.getExportTimestampCSV(a,this.exportDateFormat)},getExportSummaryCSV:function(a,b){var c=_.filter(b,function(a){return a.dataIndex||null}),d=_.map(c,function(a){return"ID"===a.text?"Formatted ID":a.text}),e=_.map(c,function(a){return a.dataIndex});this.logger.log("getExportSummaryCSV",d,e);var f=this.getCycleStates(),g=this.getStateField(),h=this.getIncludeBlocked(),i=this.getIncludeReady();d.push(this.getCycleTimeColumnHeader()),d.push(this.getCycleTimeStartColumnHeader()),d.push(this.getCycleTimeEndColumnHeader()),h&&d.push(this.getTimeInStateColumnHeader("Blocked")),i&&d.push(this.getTimeInStateColumnHeader("Ready")),Ext.Array.each(f,function(a){d.push(this.getTimeInStateColumnHeader(a))},this);for(var j=[d.join(",")],k=this.exportDateFormat,l=0;l<a.length;l++){for(var m=[],n=a[l],o=0;o<e.length;o++){var p=n.get(e[o]);if(Ext.isObject(p))if(p._tagsNameArray){var q=[];Ext.Array.each(p._tagsNameArray,function(a){q.push(a.Name)}),p=q.join(",")}else p=p._refObjectName;m.push(p||"")}var r=n.get("timeInStateData");m.push(n.get("cycleTimeData")&&n.get("cycleTimeData").cycleTime||"");var s=n.get("cycleTimeData")&&n.get("cycleTimeData").startDate||null,t=n.get("cycleTimeData")&&n.get("cycleTimeData").endDate||null,u=s&&Rally.util.DateTime.format(s,k)||"",v=t&&Rally.util.DateTime.format(t,k)||"";m.push(u),m.push(v),h&&m.push(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(r,"Blocked",null,"")),i&&m.push(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(r,"Ready",null,""));for(var w=0;w<f.length;w++)r?m.push(CArABU.technicalservices.CycleTimeCalculator.getRenderedTimeInStateValue(r[g],f[w],n.get(f[w]),"")):m.push("");m=_.map(m,function(a){return Ext.String.format('"{0}"',a.toString().replace(/"/g,'""'))}),j.push(m.join(","))}return j.join("\r\n")},getQueryFilter:function(){var a=this.getSetting("queryFilter");return a&&a.length>0?Rally.data.wsapi.Filter.fromQueryString(a):null},getIncludeBlocked:function(){return!0},getIncludeReady:function(){return!0},getFromStateCombo:function(){return this.cycleTimeFromState},getToStateCombo:function(){return this.cycleTimeToState},getToStateValue:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleEndState||null;
},getFromStateValue:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleStartState||null},getSelectedProjects:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.projects||null},getSelectedProjectOids:function(){var a=[];return Ext.Array.each(this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.projects,function(b){a.push(Rally.util.Ref.getOidFromRef(b))}),a},getLastNMonths:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.lastNMonths||null},getReqdyQueueStateValue:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleReadyQueueState||null},getStateField:function(){return this._gridConfig&&this._gridConfig.cycleTimeParameters&&this._gridConfig.cycleTimeParameters.cycleStateField||null},getModelNames:function(){var a=this.getSetting("artifactType");return"Feature"==a?["PortfolioItem/Feature"]:["HierarchicalRequirement","Defect"]},getSelectorBox:function(){return this.down("#selector_box")},getGridBox:function(){return this.down("#grid_box")},getSettingsFields:function(){return CArABU.technicalservices.CycleTimeData.Settings.getFields(this.getSettings())},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},onSettingsUpdate:function(a){this.logger.log("onSettingsUpdate",a),this.addSelectors()}});
            
               Rally.launchApp('cycle-time-summary-app', {
                   name: 'cycle-time-summary-app'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>